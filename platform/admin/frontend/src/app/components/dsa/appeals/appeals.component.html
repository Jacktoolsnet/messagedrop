<mat-toolbar color="primary">
  <button mat-icon-button routerLink="/dashboard/dsa" aria-label="Back to DSA dashboard">
    <mat-icon>arrow_back</mat-icon>
  </button>

  <span class="toolbar-title">Appeals</span>
  <span class="spacer"></span>
  <div class="desktop-controls">
    <mat-button-toggle-group [value]="statusFilter()" (valueChange)="setStatus($event)">
      <mat-button-toggle value="open">Open</mat-button-toggle>
      <mat-button-toggle value="resolved">Resolved</mat-button-toggle>
      <mat-button-toggle value="all">All</mat-button-toggle>
    </mat-button-toggle-group>
    <button mat-stroked-button color="primary" type="button" (click)="refresh()">
      <mat-icon>refresh</mat-icon>
      Refresh
    </button>
  </div>

  <div class="mobile-controls">
    <button mat-icon-button [matMenuTriggerFor]="appealsMenu" aria-label="Appeals menu">
      <mat-icon>more_vert</mat-icon>
    </button>
    <mat-menu #appealsMenu="matMenu">
      <button mat-menu-item disabled>Status</button>
      <button mat-menu-item (click)="setStatus('open')">
        <mat-icon>{{ statusFilter() === 'open' ? 'radio_button_checked' : 'radio_button_unchecked' }}</mat-icon>
        <span>Open</span>
      </button>
      <button mat-menu-item (click)="setStatus('resolved')">
        <mat-icon>{{ statusFilter() === 'resolved' ? 'radio_button_checked' : 'radio_button_unchecked' }}</mat-icon>
        <span>Resolved</span>
      </button>
      <button mat-menu-item (click)="setStatus('all')">
        <mat-icon>{{ statusFilter() === 'all' ? 'radio_button_checked' : 'radio_button_unchecked' }}</mat-icon>
        <span>All</span>
      </button>
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="refresh()">
        <mat-icon>refresh</mat-icon>
        <span>Refresh</span>
      </button>
    </mat-menu>
  </div>
</mat-toolbar>

@if (loading()) {
<mat-progress-bar mode="indeterminate"></mat-progress-bar>
}

<div class="page">
  <div class="layout">
    <div class="left-column">
      <div class="list-header">
        <div class="badge">
          <mat-icon aria-hidden="true">feedback</mat-icon>
          Appeals
        </div>
      </div>

      @if (!loading() && appeals().length === 0) {
      <div class="empty">
        <mat-icon>inventory_2</mat-icon>
        <p>No appeals found for the selected filter.</p>
      </div>
      }

      <div class="notice-list">
        @for (appeal of appeals(); track trackById($index, appeal)) {
        <mat-card class="notice-card" [class.selected]="isSelected(appeal)" (click)="selectAppeal(appeal)" tabindex="0"
          (keydown.enter)="selectAppeal(appeal)">
          <div class="head">
            <div class="title" [matTooltip]="appeal.noticeContentId || 'No content id'">
              {{ appeal.noticeContentId || 'No content id' }}
            </div>
            <div class="head-right">
              @if (isSelected(appeal)) {
              <span class="active-pill">
                <mat-icon aria-hidden="true">radio_button_checked</mat-icon>
                Active
              </span>
              }
              <span class="status-pill" [ngClass]="isOpen(appeal) ? 'status-open' : 'status-resolved'">
                <mat-icon aria-hidden="true">{{ isOpen(appeal) ? 'pending' : 'task_alt' }}</mat-icon>
                {{ isOpen(appeal) ? 'Open' : 'Resolved' }}
              </span>
            </div>
          </div>

          <div class="meta">
            <span>
              <mat-icon aria-hidden="true">event</mat-icon>
              {{ appeal.filedAt | date:'medium' }}
            </span>
            @if (appeal.resolvedAt) {
            <span>
              <mat-icon aria-hidden="true">update</mat-icon>
              {{ appeal.resolvedAt | date:'medium' }}
            </span>
            }
          </div>

          <div class="actions">
            @if (isOpen(appeal)) {
            <button mat-stroked-button color="accent" type="button"
              (click)="$event.stopPropagation(); resolveAppeal(appeal)">
              <mat-icon>done_all</mat-icon>
              Resolve appeal
            </button>
            }
          </div>
        </mat-card>
        }
      </div>
    </div>

    <div class="right-column">
      @if (rightLoading()) {
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      }

      @if (selectedAppeal() && selectedNotice()) {
      <div class="summary-header">
        <div class="badge">
          <mat-icon aria-hidden="true">article</mat-icon>
          Notice
        </div>
      </div>
      <div class="summary-grid">
        <section class="tile">
          <h3 class="tile-title">Overview</h3>
          <div class="tile-body">
            <div class="section">
              <div class="kv">
                <div class="k">ID</div>
                <div class="v mono">{{ selectedNotice()!.id }}</div>
              </div>
              <div class="kv">
                <div class="k">Created</div>
                <div class="v">{{ selectedNotice()!.createdAt | date:'medium' }}</div>
              </div>
              <div class="kv">
                <div class="k">Type</div>
                <div class="v">{{ selectedNotice()!.reportedContentType }}</div>
              </div>
              <div class="kv">
                <div class="k">Category</div>
                <div class="v">{{ selectedNotice()!.category || '—' }}</div>
              </div>
              <div class="kv">
                <div class="k">Status</div>
                <div class="v">{{ selectedNotice()!.status }}</div>
              </div>
            </div>
          </div>
        </section>

        <section class="tile">
          <h3 class="tile-title">Content</h3>
          <div class="tile-body">
            @if (contentObj(); as c) {
            <div class="block">
              @if (c.message; as message) {
              <div class="bubble">{{ message }}</div>
              <mat-divider class="sp"></mat-divider>
              }
              <div class="section">
                <div class="kv">
                  <div class="k">Content ID</div>
                  <div class="v mono">{{ selectedNotice()!.contentId }}</div>
                </div>
                @if (c.userId; as userId) {
                <div class="kv">
                  <div class="k">User</div>
                  <div class="v mono">{{ userId }}</div>
                </div>
                }
                @if (c.location?.plusCode; as plusCode) {
                <div class="kv">
                  <div class="k">PlusCode</div>
                  <div class="v mono">{{ plusCode }}</div>
                </div>
                }
                @if (c.multimedia?.type; as mediaType) {
                <div class="kv">
                  <div class="k">Media</div>
                  <div class="v">{{ mediaType }}</div>
                </div>
                }
              </div>

              @if (mediaKind() === 'iframe' && embedUrl()) {
              <div class="embed">
                <iframe [src]="embedUrl()" title="Embedded content" loading="lazy"
                  referrerpolicy="strict-origin-when-cross-origin"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen></iframe>
              </div>
              }

              @if (mediaKind() === 'image' && imageUrl()) {
              <div class="tenor-wrap">
                <img [src]="imageUrl()!" alt="media">
              </div>
              }

              @if (hasExternalLink()) {
              <div class="block-actions">
                <a mat-stroked-button class="external" [href]="externalLink()!" target="_blank" rel="noopener">
                  <mat-icon>open_in_new</mat-icon>
                  Open original
                </a>
                <button mat-stroked-button type="button" (click)="addScreenshotEvidence()"
                  [disabled]="makingScreenshot()">
                  <mat-icon>photo_camera</mat-icon>
                  Add to evidence
                </button>
              </div>
              }
            </div>
            } @else {
            <div class="placeholder"><mat-icon>info</mat-icon> No content payload attached.</div>
            }
          </div>
        </section>

        <section class="tile">
          <h3 class="tile-title">Metadata</h3>
          <div class="tile-body">
            <div class="section">
              <div class="kv">
                <div class="k">Reporter name</div>
                <div class="v">{{ selectedNotice()!.reporterName || '—' }}</div>
              </div>
              <div class="kv">
                <div class="k">Reporter email</div>
                <div class="v">{{ selectedNotice()!.reporterEmail || '—' }}</div>
              </div>
              <div class="kv">
                <div class="k">Truth affirmation</div>
                <div class="v">{{ selectedNotice()!.truthAffirmation ? 'Yes' : '—' }}</div>
              </div>
              <div class="kv">
                <div class="k">Updated</div>
                <div class="v">{{ selectedNotice()!.updatedAt | date:'medium' }}</div>
              </div>
            </div>
          </div>
        </section>

        <section class="tile">
          <h3 class="tile-title">Evidence</h3>
          <div class="tile-body">
            <app-evidence-list [noticeId]="selectedNotice()!.id"></app-evidence-list>
          </div>
        </section>

        <section class="tile">
          <h3 class="tile-title">Decision summary</h3>
          <div class="tile-body">
            <app-decision-summary [noticeId]="selectedNotice()!.id"></app-decision-summary>
          </div>
        </section>

        <section class="tile">
          <h3 class="tile-title">Appeals</h3>
          <div class="tile-body">
            <app-notice-appeals [noticeId]="selectedNotice()!.id"></app-notice-appeals>
          </div>
        </section>
      </div>
      } @else {
      @if (!loading() && appeals().length !== 0) {
      <div class="placeholder empty">
        <mat-icon>notifications_none</mat-icon>
        <div class="placeholder-text">
          Select an appeal to view its summary.
        </div>
      </div>
      }
      }
    </div>
  </div>
</div>
