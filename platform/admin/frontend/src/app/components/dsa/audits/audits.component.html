<mat-toolbar>
    <button mat-icon-button routerLink="/dashboard/dsa" aria-label="Back">
        <mat-icon>arrow_back</mat-icon>
    </button>
    <span class="toolbar-title">Audits</span>
    <button mat-stroked-button (click)="load()">
        <mat-icon>refresh</mat-icon>
        Refresh
    </button>
</mat-toolbar>

@if (loading()) {
<mat-progress-bar mode="indeterminate"></mat-progress-bar>
}

<div class="page">
    <!-- Filter -->
    <div class="filter-row">
        <mat-form-field appearance="outline">
            <mat-label>Entity</mat-label>
            <mat-select [formControl]="filterForm.controls.entityType">
                <mat-option value="">All</mat-option>
                <mat-option value="notice">Notice</mat-option>
                <mat-option value="signal">Signal</mat-option>
                <mat-option value="decision">Decision</mat-option>
                <mat-option value="public_message">Public message</mat-option>
                <mat-option value="user">User</mat-option>
                <mat-option value="other">Other</mat-option>
            </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
            <mat-label>Action</mat-label>
            <mat-select [formControl]="filterForm.controls.action">
                <mat-option value="">All</mat-option>
                <mat-option value="create">Create</mat-option>
                <mat-option value="status_change">Status change</mat-option>
                <mat-option value="evidence_add">Evidence add</mat-option>
                <mat-option value="notify">Notify</mat-option>
                <mat-option value="delete">Delete</mat-option>
            </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
            <mat-label>Range</mat-label>
            <mat-select [formControl]="filterForm.controls.range">
                <mat-option value="24h">Last 24h</mat-option>
                <mat-option value="7d">Last 7 days</mat-option>
                <mat-option value="30d">Last 30 days</mat-option>
                <mat-option value="all">All</mat-option>
            </mat-select>
        </mat-form-field>

        <mat-form-field class="grow" appearance="outline">
            <mat-label>Search</mat-label>
            <input matInput [formControl]="filterForm.controls.q" placeholder="actor, entityId, action…" />
        </mat-form-field>
    </div>

    <!-- Timeline -->
    <div class="timeline">
        @for (e of items(); track trackById($index, e)) {
        <div class="row" (click)="openEntity(e)">
            <div class="left">
                <div class="avatar"><mat-icon>{{ iconForAction(e.action) }}</mat-icon></div>
                <div class="head">
                    <div class="title">{{ labelForAction(e.action) }}</div>
                    <div class="meta">
                        <span class="etype">{{ e.entityType }}</span>
                        <span class="dot">•</span>
                        <span class="date">{{ e.createdAt | date:'medium' }}</span>
                    </div>
                </div>
            </div>

            <div class="right">
                @let rows = detailRows(e);
                @if (rows.length > 0) {
                <div class="kv-list">
                    @for (r of rows; track r.k) {
                    <div class="head">
                        <div class="title">{{ r.k }}</div>
                        <div class="meta">{{ r.v }}</div>
                    </div>
                    }
                </div>
                } @else {
                <div class="empty-details">No additional details.</div>
                }
            </div>
        </div>
        }

        @if (!loading() && items().length === 0) {
        <div class="empty">
            <mat-icon>inbox</mat-icon>
            <div>No audit entries in this range.</div>
        </div>
        }
    </div>
</div>