<div class="dialog-shell">
    <!-- Header -->
    <div class="dialog-header">
        <div class="left">
            <mat-icon>infos</mat-icon>
            <h3>Notice Detail</h3>
        </div>
        <div class="right">
            <mat-chip-set>
                <mat-chip class="status" [ngClass]="status()">{{ status() }}</mat-chip>
            </mat-chip-set>
            <div class="actions">
            </div>
        </div>
    </div>

    <mat-divider></mat-divider>

    <!-- Body (Tabs) -->
    <div class="dialog-body">
        <div class="tiles-grid">
            <section class="tile">
                <h3 class="tile-title">Overview</h3>
                <div class="tile-body">
                    <div class="section">
                        <div class="kv">
                            <div class="k">ID</div>
                            <div class="v mono">{{ notice().id }}</div>
                        </div>
                        <div class="kv">
                            <div class="k">Created</div>
                            <div class="v">{{ notice().createdAt | date:'medium' }}</div>
                        </div>
                        <div class="kv">
                            <div class="k">Type</div>
                            <div class="v">{{ notice().reportedContentType }}</div>
                        </div>
                        <div class="kv">
                            <div class="k">Category</div>
                            <div class="v">{{ notice().category || '—' }}</div>
                        </div>
                    </div>

                    <div class="block">
                        <h4><mat-icon>flag</mat-icon> Reason (original)</h4>
                        @if (notice().reasonText) {
                        <div class="bubble">{{ notice().reasonText }}</div>
                        <div class="i18n-row">
                            <button mat-stroked-button (click)="translateToGerman('reason')"
                                [disabled]="reasonI18n().loading">
                                <mat-icon>translate</mat-icon>
                                @if (reasonI18n().loading) { Translating… } @else { Translate to German }
                            </button>
                        </div>
                        @if (reasonI18n().translated) {
                        <div class="translation">
                            <mat-icon>g_translate</mat-icon>
                            <div class="t">{{ reasonI18n().translated }}</div>
                        </div>
                        }
                        } @else {
                        <div class="placeholder"><mat-icon>info</mat-icon> No reason provided.</div>
                        }
                    </div>
                </div>
            </section>

            <section class="tile">
                <h3 class="tile-title">Content</h3>
                <div class="tile-body">
                    <div class="block">
                        <h4><mat-icon>article</mat-icon> Reported content</h4>

                        @if (contentObj(); as c) {
                        <div class="bubble">
                            @if (c.message; as message) {
                            <div class="msg">{{ message }}</div>
                            @if ((c.hashtags?.length ?? 0) > 0) {
                            <div class="message-hashtags" aria-label="Message hashtags">
                                @for (tag of c.hashtags ?? []; track tag) {
                                <span class="message-hashtag-chip">#{{ tag }}</span>
                                }
                            </div>
                            }
                            <div class="i18n-row">
                                <button mat-stroked-button (click)="translateToGerman('message')"
                                    [disabled]="messageI18n().loading">
                                    <mat-icon>translate</mat-icon>
                                    @if (messageI18n().loading) { Translating… } @else { Translate to German }
                                </button>
                            </div>
                            @if (messageI18n().translated) {
                            <div class="translation">
                                <mat-icon>g_translate</mat-icon>
                                <div class="t">{{ messageI18n().translated }}</div>
                            </div>
                            }
                            <mat-divider class="sp"></mat-divider>
                            }

                            <div class="meta">
                                <div class="kv">
                                    <div class="k">Content ID</div>
                                    <div class="v mono">{{ notice().contentId }}</div>
                                </div>
                                @if (c.userId; as userId) {
                                <div class="kv">
                                    <div class="k">User</div>
                                    <div class="v mono">{{ userId }}</div>
                                </div>
                                }
                                @if (c.location?.plusCode; as plusCode) {
                                <div class="kv">
                                    <div class="k">PlusCode</div>
                                    <div class="v mono">{{ plusCode }}</div>
                                </div>
                                }
                                @if (c.multimedia?.type; as mediaType) {
                                <div class="kv">
                                    <div class="k">Media</div>
                                    <div class="v">{{ mediaType }}</div>
                                </div>
                                }
                            </div>
                        </div>

                        <!-- Media Preview -->
                        @if (youtubeEmbedHtml(); as yth) {
                        <div class="embed" [innerHTML]="yth"></div>
                        } @else if (tenorGifUrl(); as gif) {
                        <div class="tenor-wrap"><img [src]="gif" alt="tenor gif" /></div>
                        }

                        <!-- Open original + Add to evidence (screenshot) -->
                        @if (hasExternalLink()) {
                        <div class="block-actions">
                            <a mat-stroked-button class="external" [href]="externalLink()!" target="_blank"
                                rel="noopener">
                                <mat-icon>open_in_new</mat-icon> Open original
                            </a>
                            <button mat-stroked-button class="external" type="button" (click)="addScreenshotEvidence()"
                                [disabled]="makingScreenshot()">
                                <mat-icon>photo_camera</mat-icon>
                                Add to evidence
                            </button>
                        </div>
                        }
                        } @else {
                        <div class="placeholder"><mat-icon>info</mat-icon> No content payload attached.</div>
                        }
                    </div>
                    @if (hasModeration()) {
                    <div class="block">
                        <h4><mat-icon>verified_user</mat-icon> Moderation ratings</h4>
                        <div class="meta">
                            <div class="kv">
                                <div class="k">AI decision</div>
                                <div class="v">{{ contentObj()?.aiModerationDecision || '—' }}</div>
                            </div>
                            <div class="kv">
                                <div class="k">AI score</div>
                                <div class="v">{{ formatScore(contentObj()?.aiModerationScore) }}</div>
                            </div>
                            <div class="kv">
                                <div class="k">AI flagged</div>
                                <div class="v">{{ formatBool(contentObj()?.aiModerationFlagged) }}</div>
                            </div>
                            <div class="kv">
                                <div class="k">AI checked</div>
                                <div class="v">{{ formatTimestamp(contentObj()?.aiModerationAt) }}</div>
                            </div>
                            <div class="kv">
                                <div class="k">Pattern match</div>
                                <div class="v">{{ formatBool(contentObj()?.patternMatch) }}</div>
                            </div>
                            <div class="kv">
                                <div class="k">Pattern checked</div>
                                <div class="v">{{ formatTimestamp(contentObj()?.patternMatchAt) }}</div>
                            </div>
                            <div class="kv">
                                <div class="k">Manual decision</div>
                                <div class="v">{{ contentObj()?.manualModerationDecision || '—' }}</div>
                            </div>
                            <div class="kv">
                                <div class="k">Manual reason</div>
                                <div class="v">{{ contentObj()?.manualModerationReason || '—' }}</div>
                            </div>
                            <div class="kv">
                                <div class="k">Manual reviewed</div>
                                <div class="v">{{ formatTimestamp(contentObj()?.manualModerationAt) }}</div>
                            </div>
                            <div class="kv">
                                <div class="k">Manual reviewer</div>
                                <div class="v">{{ contentObj()?.manualModerationBy || '—' }}</div>
                            </div>
                        </div>
                    </div>
                    }
                </div>
            </section>

            <section class="tile">
                <h3 class="tile-title">Metadata</h3>
                <div class="tile-body">
                    <div class="section">
                        <div class="kv">
                            <div class="k">Reporter name</div>
                            <div class="v">{{ notice().reporterName || '—' }}</div>
                        </div>
                        <div class="kv">
                            <div class="k">Reporter email</div>
                            <div class="v">{{ notice().reporterEmail || '—' }}</div>
                        </div>
                        <div class="kv">
                            <div class="k">Truth affirmation</div>
                            <div class="v">{{ notice().truthAffirmation ? 'Yes' : '—' }}</div>
                        </div>
                        <div class="kv">
                            <div class="k">Updated</div>
                            <div class="v">{{ notice().updatedAt | date:'medium' }}</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="tile">
                <h3 class="tile-title">Evidence</h3>
                <div class="tile-body">
                    <div class="tile-actions">
                        <button mat-stroked-button color="primary" type="button" (click)="openAddEvidence()">
                            <mat-icon>add</mat-icon>
                            Add evidence
                        </button>
                    </div>
                    <app-evidence-list #evidenceList [noticeId]="notice().id"></app-evidence-list>
                </div>
            </section>

            <section class="tile">
                <h3 class="tile-title">Decision summary</h3>
                <div class="tile-body">
                    <div class="tile-actions">
                        <button mat-stroked-button color="accent" type="button" (click)="openDecisionDialog()"
                            [disabled]="status() === 'DECIDED'">
                            <mat-icon>gavel</mat-icon>
                            Decide
                        </button>
                    </div>
                    <app-decision-summary #decisionSummary [noticeId]="notice().id"></app-decision-summary>
                </div>
            </section>

            <section class="tile">
                <h3 class="tile-title">Appeals</h3>
                <div class="tile-body">
                    <app-notice-appeals [noticeId]="notice().id"></app-notice-appeals>
                </div>
            </section>
        </div>
    </div>

    <!-- Footer -->
    <div class="dialog-footer">
        <button mat-stroked-button (click)="openStatusPage()">
            <mat-icon>open_in_new</mat-icon>
            Open status
        </button>
        <button mat-stroked-button (click)="close(false)">
            <mat-icon>close</mat-icon> Close
        </button>
    </div>
</div>
