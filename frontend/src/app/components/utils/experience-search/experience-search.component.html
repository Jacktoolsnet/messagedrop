<mat-dialog-content class="experience-dialog-content">
  <div class="experience-scroll">
    <div class="search-bar">
      <input type="search" enterkeyhint="search" [formControl]="form.controls.term" (keyup.enter)="onSearch()"
        [placeholder]="'common.experiences.searchPlaceholder' | transloco" />
      <button type="button" class="filter-button" [matMenuTriggerFor]="filterMenu"
        [attr.aria-label]="'common.actions.more' | transloco">
        <mat-icon>tune</mat-icon>
      </button>
      <button type="button" class="sort-button" [matMenuTriggerFor]="sortMenu"
        [attr.aria-label]="'common.experiences.sort' | transloco">
        <mat-icon>sort</mat-icon>
      </button>
      <button type="button" class="search-button" (click)="onSearch()" [disabled]="loading() || !canSearch()"
        [attr.aria-label]="'common.experiences.search' | transloco">
        <mat-icon>search</mat-icon>
      </button>
    </div>
    <mat-menu #sortMenu="matMenu">
      <div class="sort-menu-content">
        <mat-radio-group class="sort-menu-group" [formControl]="form.controls.sort">
          @for (option of sortOptions; track option.value) {
            <mat-radio-button [value]="option.value">{{ option.labelKey | transloco }}</mat-radio-button>
          }
        </mat-radio-group>
      </div>
    </mat-menu>
    <mat-menu #filterMenu="matMenu">
      <div class="filter-menu-content" (click)="$event.stopPropagation()">
        <div class="filter-tiles">
          <section class="filter-tile">
            <div class="tile-header">
              <mat-icon>event</mat-icon>
              <span>{{ 'common.experiences.dateFrom' | transloco }} / {{ 'common.experiences.dateTo' | transloco }}</span>
            </div>
            <div class="tile-body tile-grid">
              <mat-form-field appearance="outline">
                <mat-label>{{ 'common.experiences.dateFrom' | transloco }}</mat-label>
                <input matInput [matDatepicker]="startPicker" [formControl]="form.controls.startDate" />
                <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                <mat-datepicker #startPicker></mat-datepicker>
              </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'common.experiences.dateTo' | transloco }}</mat-label>
            <input matInput [matDatepicker]="endPicker" [formControl]="form.controls.endDate"
              [min]="form.controls.startDate.value" [disabled]="!form.controls.startDate.value" />
            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>
            </div>
          </section>

          <section class="filter-tile">
            <div class="tile-header">
              <mat-icon>payments</mat-icon>
              <span>{{ 'common.experiences.minPrice' | transloco }} / {{ 'common.experiences.maxPrice' | transloco }}</span>
            </div>
            <div class="tile-body">
              <div class="slider-block">
                <mat-slider [min]="priceRange.min" [max]="priceRange.max" [step]="priceRange.step" thumbLabel tickInterval="0">
                  <input matSliderStartThumb [formControl]="form.controls.minPrice" />
                  <input matSliderEndThumb [formControl]="form.controls.maxPrice" />
                </mat-slider>
                <div class="slider-values">
                  <span>{{ form.controls.minPrice.value }} {{ form.controls.currency.value }}</span>
                  <span>{{ form.controls.maxPrice.value }} {{ form.controls.currency.value }}</span>
                </div>
              </div>
            </div>
          </section>

          <section class="filter-tile">
            <div class="tile-header">
              <mat-icon>schedule</mat-icon>
              <span>{{ 'common.experiences.minDuration' | transloco }} / {{ 'common.experiences.maxDuration' | transloco }}</span>
            </div>
            <div class="tile-body">
              <div class="slider-block">
                <mat-slider [min]="durationRange.min" [max]="durationRange.max" [step]="durationRange.step" thumbLabel tickInterval="0">
                  <input matSliderStartThumb [formControl]="form.controls.minDurationHours" />
                  <input matSliderEndThumb [formControl]="form.controls.maxDurationHours" />
                </mat-slider>
                <div class="slider-values">
                  <span>{{ form.controls.minDurationHours.value }} h</span>
                  <span>{{ form.controls.maxDurationHours.value }} h</span>
                </div>
              </div>
            </div>
          </section>

          <section class="filter-tile">
            <div class="tile-header">
              <mat-icon>paid</mat-icon>
              <span>{{ 'common.experiences.currency' | transloco }}</span>
            </div>
            <div class="tile-body">
              <mat-form-field appearance="outline">
                <mat-label>{{ 'common.experiences.currency' | transloco }}</mat-label>
                <mat-select [formControl]="form.controls.currency">
                  @for (code of currencyOptions; track code) {
                    <mat-option [value]="code">{{ code }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          </section>
        </div>

        <div class="filters-actions">
          <button mat-stroked-button type="button" (click)="onReset()" [disabled]="loading()">
            <mat-icon>restart_alt</mat-icon>
            {{ 'common.experiences.reset' | transloco }}
          </button>
        </div>
      </div>
    </mat-menu>

    <section class="results-panel">
      @if (viewMode() === 'map') {
        <app-search-settings-map-preview class="map-preview-full" [center]="worldCenter" [zoom]="3"
          [markers]="mapMarkers()" [fitMarkers]="true" [interactive]="true">
        </app-search-settings-map-preview>
      }

      @if (viewMode() === 'list') {
        <div class="results" role="list">
          @for (result of results(); track result.trackId) {
            <article class="result-card" role="listitem" [class.result-card--selected]="selectedResult()?.trackId === result.trackId"
              [attr.title]="result.title || result.productCode || ''">
              @if (result.imageUrl) {
                <img class="result-image" [src]="result.imageUrl" [alt]="result.title || result.productCode || ''"
                  [attr.title]="result.title || result.productCode || ''" />
              }
              <div class="result-content">
                <div class="result-header">
                  <h3 class="result-title" [attr.title]="result.title || result.productCode || ''">{{ result.title || result.productCode }}</h3>
                  @if (result.duration) {
                    <span class="result-duration">{{ result.duration }}</span>
                  }
                </div>
                @if (result.description) {
                  <p class="result-description">{{ result.description }}</p>
                }
                <div class="result-meta">
                  @if (getRatingLabel(result)) {
                    <span class="meta-item">â˜… {{ getRatingLabel(result) }}</span>
                  }
                  @if (getPriceLabel(result)) {
                    <span class="meta-item">{{ getPriceLabel(result) }}</span>
                  }
                </div>
                <div class="result-actions">
                  <button mat-stroked-button type="button" (click)="onOpen(result)" [disabled]="!result.productUrl"
                    [attr.aria-label]="'common.experiences.openOn' | transloco : { provider: 'Viator' }">
                    {{ 'common.experiences.openOn' | transloco : { provider: 'Viator' } }}
                  </button>
                  <button mat-flat-button color="primary" type="button" (click)="onSelect(result)">
                    {{ 'common.experiences.select' | transloco }}
                  </button>
                </div>
              </div>
            </article>
          }
        </div>

        @if (canLoadMore()) {
          <div class="load-more">
            <button mat-stroked-button type="button" (click)="onLoadMore()">
              {{ 'common.experiences.loadMore' | transloco }}
            </button>
          </div>
        }
      }
    </section>
  </div>
</mat-dialog-content>

<mat-dialog-actions class="sticky-actions" align="end">
  <button mat-dialog-close mat-icon-button class="action-close"
    [attr.aria-label]="'common.actions.abort' | transloco">
    <mat-icon>close</mat-icon>
  </button>
  <button mat-icon-button type="button" (click)="help.open('experienceSearch')"
    [attr.aria-label]="'common.actions.help' | transloco">
    <mat-icon>help</mat-icon>
  </button>
  <button mat-icon-button type="button" (click)="toggleViewMode()"
    [attr.aria-label]="viewMode() === 'list' ? ('common.location.switchToMap' | transloco) : ('common.location.switchToList' | transloco)">
    <mat-icon>{{ viewMode() === 'list' ? 'map' : 'list' }}</mat-icon>
  </button>
  <button mat-icon-button color="primary" type="button" (click)="onApply()" [disabled]="!selectedResult()"
    [attr.aria-label]="'common.actions.apply' | transloco">
    <mat-icon>check</mat-icon>
  </button>
</mat-dialog-actions>
