<mat-dialog-content class="experience-dialog-content">
  <div class="search-bar">
    <input type="search" enterkeyhint="search" [formControl]="form.controls.term" (keyup.enter)="onSearch()"
      [placeholder]="destinationName
        ? ('common.experiences.searchPlaceholderWithDestination' | transloco: { destination: destinationName })
        : ('common.experiences.searchPlaceholder' | transloco)" />
    <button type="button" class="filter-button" [matMenuTriggerFor]="filterMenu"
      [attr.aria-label]="'common.actions.more' | transloco">
      <mat-icon>tune</mat-icon>
    </button>
    <button type="button" class="sort-button" [matMenuTriggerFor]="sortMenu"
      [attr.aria-label]="'common.experiences.sort' | transloco">
      <mat-icon>sort</mat-icon>
    </button>
    <button type="button" class="search-button" (click)="onSearchButtonClick()" [disabled]="loading() || !canSearch()"
      [attr.aria-label]="canLoadMore() && !hasSearchChanged()
          ? ('common.experiences.loadMore' | transloco)
          : ('common.experiences.search' | transloco)">
      <mat-icon>{{ canLoadMore() && !hasSearchChanged() ? 'refresh' : 'search' }}</mat-icon>
    </button>
  </div>
  <div class="experience-scroll">
    <mat-menu #sortMenu="matMenu">
      <div class="sort-menu-content">
        <mat-radio-group class="sort-menu-group" [formControl]="form.controls.sort">
          @for (option of sortOptions; track option.value) {
          <mat-radio-button [value]="option.value">{{ option.labelKey | transloco }}</mat-radio-button>
          }
        </mat-radio-group>
      </div>
    </mat-menu>
    <mat-menu #filterMenu="matMenu">
      <div class="filter-menu-content" tabindex="0" (click)="$event.stopPropagation()"
        (keydown)="$event.stopPropagation()">
        <div class="filter-tiles">
          <section class="filter-tile">
            <div class="filter-tile-header">
              <mat-icon>event</mat-icon>
              <span>{{ 'common.experiences.dateFrom' | transloco }} / {{ 'common.experiences.dateTo' | transloco
                }}</span>
            </div>
            <div class="tile-body tile-grid">
              <mat-form-field appearance="outline">
                <mat-label>{{ 'common.experiences.dateFrom' | transloco }}</mat-label>
                <input matInput [matDatepicker]="startPicker" [formControl]="form.controls.startDate" />
                <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                <mat-datepicker #startPicker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>{{ 'common.experiences.dateTo' | transloco }}</mat-label>
                <input matInput [matDatepicker]="endPicker" [formControl]="form.controls.endDate"
                  [min]="form.controls.startDate.value" [disabled]="!form.controls.startDate.value" />
                <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                <mat-datepicker #endPicker></mat-datepicker>
              </mat-form-field>
            </div>
          </section>

          <section class="filter-tile">
            <div class="filter-tile-header">
              <mat-icon>payments</mat-icon>
              <span>{{ 'common.experiences.minPrice' | transloco }} / {{ 'common.experiences.maxPrice' | transloco
                }}</span>
            </div>
            <div class="tile-body">
              <div class="slider-block">
                <mat-slider [min]="priceRange.min" [max]="priceRange.max" [step]="priceRange.step" thumbLabel
                  tickInterval="0">
                  <input matSliderStartThumb [formControl]="form.controls.minPrice" />
                  <input matSliderEndThumb [formControl]="form.controls.maxPrice" />
                </mat-slider>
                <div class="slider-values">
                  <span>{{ form.controls.minPrice.value }} {{ form.controls.currency.value }}</span>
                  <span>{{ form.controls.maxPrice.value }} {{ form.controls.currency.value }}</span>
                </div>
              </div>
            </div>
          </section>

          <section class="filter-tile">
            <div class="filter-tile-header">
              <mat-icon>schedule</mat-icon>
              <span>{{ 'common.experiences.minDuration' | transloco }} / {{ 'common.experiences.maxDuration' | transloco
                }}</span>
            </div>
            <div class="tile-body">
              <div class="slider-block">
                <mat-slider [min]="durationRange.min" [max]="durationRange.max" [step]="durationRange.step" thumbLabel
                  tickInterval="0">
                  <input matSliderStartThumb [formControl]="form.controls.minDurationHours" />
                  <input matSliderEndThumb [formControl]="form.controls.maxDurationHours" />
                </mat-slider>
                <div class="slider-values">
                  <span>{{ form.controls.minDurationHours.value }} h</span>
                  <span>{{ form.controls.maxDurationHours.value }} h</span>
                </div>
              </div>
            </div>
          </section>

          <section class="filter-tile">
            <div class="filter-tile-header">
              <mat-icon>paid</mat-icon>
              <span>{{ 'common.experiences.currency' | transloco }}</span>
            </div>
            <div class="tile-body">
              <mat-form-field appearance="outline">
                <mat-select [formControl]="form.controls.currency">
                  @for (code of currencyOptions; track code) {
                  <mat-option [value]="code">{{ code }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          </section>
        </div>

        <div class="filters-actions">
          <button mat-stroked-button type="button" (click)="onReset()" [disabled]="loading()">
            <mat-icon>restart_alt</mat-icon>
            {{ 'common.experiences.reset' | transloco }}
          </button>
        </div>
      </div>
    </mat-menu>

    <section class="results-panel">
      @if (viewMode() === 'map') {
      <app-search-settings-map-preview class="map-preview-full" [center]="worldCenter" [zoom]="3"
        [markers]="mapMarkers()" [fitMarkers]="true" [interactive]="true"
        [markerIconUrl]="'assets/markers/experience-marker.svg'" (markerClick)="onMarkerClick($event)">
      </app-search-settings-map-preview>
      }

      @if (viewMode() === 'list') {
      <div class="results" role="list">
        @for (result of results(); track result.trackId) {
        <mat-card class="experience-tile" role="listitem" (click)="onSelect(result)"
          [class.experience-tile--selected]="selectedResult()?.trackId === result.trackId"
          [attr.title]="result.title || result.productCode || ''">
          <div class="tile-header" [style.--experience-header-bg-image]="getExperienceHeaderBackgroundImage(result)"
            [style.--experience-header-bg-opacity]="getExperienceHeaderBackgroundOpacity(result)">
            <div class="identity-badge">
              @if (result.avatarUrl) {
              <img class="avatar" [src]="result.avatarUrl" [alt]="result.title || result.productCode || ''" />
              } @else {
              <mat-icon>{{ getExperienceIcon() }}</mat-icon>
              }
              <div class="identity-text">
                <span class="name" [attr.title]="result.title || result.productCode || ''">
                  {{ result.title || result.productCode }}
                </span>
                @if (getDurationLabel(result)) {
                <span class="subtitle">{{ 'common.experiences.durationPrefix' | transloco }} {{ getDurationLabel(result)
                  }}</span>
                }
              </div>
            </div>
            <div class="viator-badge">
              <span class="viator-badge__text">{{ 'common.experiences.sourceViator' | transloco }}</span>
              <a class="viator-badge__link" href="https://www.viator.com/?pid=P00285785&mcid=42383&medium=link"
                target="_blank" rel="noopener">
                Viator
              </a>
            </div>
            @if (getRatingLabel(result)) {
            <div class="rating-badge">â˜… {{ getRatingLabel(result) }}</div>
            }
          </div>
          <mat-card-content class="experience-content">
            @if (result.description) {
            <p class="result-description">
              {{ result.description }}
            </p>
            }
            <div class="result-meta">
            </div>
          </mat-card-content>
          <mat-card-actions class="tile-actions">
            <div class="tile-actions__left">
              <button mat-mini-fab color="primary" type="button" (click)="openDetails(result); $event.stopPropagation()"
                [attr.aria-label]="'common.experiences.showMore' | transloco">
                <mat-icon>expand_content</mat-icon>
              </button>
              @if (isChatContext) {
              <button mat-mini-fab color="secondary" type="button" (click)="sendToChat(result, $event)"
                [attr.aria-label]="'common.experiences.sendToChat' | transloco">
                <mat-icon>chat_paste_go_2</mat-icon>
              </button>
              } @else {
              <button mat-mini-fab color="secondary" type="button" (click)="onToggleBookmark(result, $event)"
                [attr.aria-label]="isBookmarked(result)
                  ? ('common.experiences.saveRemovedTitle' | transloco)
                  : ('common.experiences.saveTitle' | transloco)">
                <mat-icon>{{ isBookmarked(result) ? 'bookmark_remove' : 'bookmark_add' }}</mat-icon>
              </button>
              }
            </div>
            <div class="tile-actions__right">
              <button mat-raised-button color="primary" class="open-viator-button" type="button"
                (click)="onOpen(result); $event.stopPropagation()" [disabled]="!result.productUrl"
                [attr.aria-label]="'common.experiences.openOn' | transloco : { provider: 'Viator' }">
                <mat-icon>shopping_cart</mat-icon>
                <span class="open-viator-label">
                  {{ getPriceLabel(result) || ('common.experiences.openOn' | transloco : { provider: 'Viator' }) }}
                </span>
              </button>
            </div>
          </mat-card-actions>
        </mat-card>
        }
      </div>

      }
    </section>
  </div>
</mat-dialog-content>

<mat-dialog-actions class="sticky-actions" align="end">
  <button mat-dialog-close mat-icon-button class="action-close" [attr.aria-label]="'common.actions.abort' | transloco">
    <mat-icon>close</mat-icon>
  </button>
  <button mat-icon-button type="button" (click)="help.open('experienceSearch')"
    [attr.aria-label]="'common.actions.help' | transloco">
    <mat-icon>help</mat-icon>
  </button>
  <button mat-icon-button type="button" (click)="onSearchButtonClick()" [disabled]="loading() || !canSearch()"
    [attr.aria-label]="canLoadMore() && !hasSearchChanged()
        ? ('common.experiences.loadMore' | transloco)
        : ('common.experiences.search' | transloco)">
    <mat-icon>{{ canLoadMore() && !hasSearchChanged() ? 'refresh' : 'search' }}</mat-icon>
  </button>
  <button mat-icon-button type="button" (click)="toggleViewMode()"
    [attr.aria-label]="viewMode() === 'list' ? ('common.location.switchToMap' | transloco) : ('common.location.switchToList' | transloco)">
    <mat-icon>{{ viewMode() === 'list' ? 'map' : 'list' }}</mat-icon>
  </button>
</mat-dialog-actions>
