<mat-dialog-content class="dialog">
    <button [attr.aria-hidden]="false" class="button_back" mat-mini-fab color="accent" aria-label="Back"
        (click)="goBack()">
        <mat-icon [attr.aria-hidden]="false" class="material-symbols-outlined">collapse_content</mat-icon>
    </button>
    <button [attr.aria-hidden]="false" class="button_add" mat-mini-fab color="primary" aria-label="Back"
        *ngIf="messageService.getSelectedMessages().length == 0" (click)="addMessagDialog()">
        <mat-icon [attr.aria-hidden]="false" class="material-symbols-outlined">add</mat-icon>
    </button>
    <button class="button_add"
        *ngIf="messageService.getSelectedMessages().length != 0 && user.id != messageService.getSelectedMessages().at(-1)?.userId"
        mat-mini-fab color="primary" aria-label="Drop a comment"
        (click)="addComment(messageService.getSelectedMessages().at(-1)!)">
        <mat-icon>add_comment</mat-icon>
    </button>
    <div *ngIf="this.messageService.getSelectedMessages()?.length === 0" class="content">
        <mat-card class="item" *ngFor="let message of messages; index as i">
            <div *ngIf="user.id == message.userId && (user.base64Avatar != '' || user.name != '')" class="avatar-box">
                <img *ngIf="user.id == message.userId && user.base64Avatar != '' && user.id == message.userId"
                    class="avatar" src="{{user.base64Avatar}}" />
                <span *ngIf="user.name != ''" class="name">{{user.name}}</span>
            </div>
            <div class="avatar-box"
                *ngIf="user.id != message.userId && (profileService.getProfile(message.userId)?.base64Avatar != '' || profileService.getProfile(message.userId)?.name != '')">
                <img *ngIf="user.id != message.userId && profileService.getProfile(message.userId)?.base64Avatar != ''"
                    class="avatar" src="{{profileService.getProfile(message.userId)?.base64Avatar}}">
                <span *ngIf="profileService.getProfile(message.userId)?.name != ''"
                    class="name">{{profileService.getProfile(message.userId)?.name}}</span>
            </div>
            <button [attr.aria-hidden]="false" class="button_detail" mat-mini-fab color="secondary" aria-label="Detial"
                (click)="goToMessageDetails(message)">
                <mat-icon [attr.aria-hidden]="false" class="material-symbols-outlined">expand_content</mat-icon>
            </button>
            <!--mat-card-header>
                <mat-card-title *ngIf="user.id == message.userId">{{user.name}}</mat-card-title>
                <mat-card-title
                    *ngIf="user.id != message.userId && profileService.getProfile(message.userId)?.name != ''">{{profileService.getProfile(message.userId)?.name}}</mat-card-title>
                <mat-card-subtitle></mat-card-subtitle>
            </mat-card-header-->
            <mat-card-content>
                <div class="message-content">
                    <app-showmultimedia [multimedia]="message.multimedia"></app-showmultimedia>
                    <app-showmessage *ngIf="message.message"
                        [message]="undefined != message.translatedMessage ? message.translatedMessage : message.message"
                        [style]="message.style"></app-showmessage>
                </div>
            </mat-card-content>
        </mat-card>
    </div>
    <!-- Message Detail view-->
    <div *ngIf="messageService.getSelectedMessages()?.length != 0">
        <mat-card class="item">
            <img *ngIf="user.base64Avatar != '' && user.id == messageService.getSelectedMessages().at(-1)?.userId"
                class="avatar" src="{{user.base64Avatar}}" />
            <img *ngIf="profileService.getProfile(messageService.getSelectedMessages().at(-1)!.userId)?.base64Avatar && user.id != messageService.getSelectedMessages().at(-1)?.userId"
                class="avatar"
                src="{{profileService.getProfile(messageService.getSelectedMessages().at(-1)!.userId)?.base64Avatar}}" />
            <mat-card-header>
                <mat-card-title *ngIf="user.id == messageService.getSelectedMessages().at(-1)?.userId"
                    (click)="editMessage(messageService.getSelectedMessages().at(-1)!)">{{user.name}}</mat-card-title>
                <mat-card-title
                    *ngIf="profileService.getProfile(messageService.getSelectedMessages().at(-1)!.userId) && user.id != messageService.getSelectedMessages().at(-1)?.userId"
                    (click)="editMessageUserProfile(messageService.getSelectedMessages().at(-1)!)">{{profileService.getProfile(messageService.getSelectedMessages().at(-1)!.userId)?.name}}</mat-card-title>
                <mat-card-subtitle></mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
                <app-showmultimedia
                    [multimedia]="messageService.getSelectedMessages().at(-1)!.multimedia"></app-showmultimedia>
                <app-showmessage
                    [message]="undefined != messageService.getSelectedMessages().at(-1)!.translatedMessage ? messageService.getSelectedMessages().at(-1)!.translatedMessage : messageService.getSelectedMessages().at(-1)!.message"
                    [style]="messageService.getSelectedMessages().at(-1)!.style"></app-showmessage>
            </mat-card-content>
            <mat-card-actions class="buttonbar">
                <button *ngIf="user.id != messageService.getSelectedMessages().at(-1)?.userId" mat-mini-fab
                    [color]="likeButtonColor" aria-label="Like message"
                    (click)="likeMessage(messageService.getSelectedMessages().at(-1)!)">
                    <mat-icon aria-hidden="false" class="material-symbols-outlined"
                        matBadge="{{messageService.getSelectedMessages().at(-1)!.likes | shortNumber}}"
                        matBadgePosition="after" matBadgeColor="accent" matBadgeOverlap="true">thumb_up</mat-icon>
                </button>
                <button *ngIf="user.id != messageService.getSelectedMessages().at(-1)?.userId" mat-mini-fab
                    [color]="dislikeButtonColor" aria-label="Dislike message"
                    (click)="dislikeMessage(messageService.getSelectedMessages().at(-1)!)">
                    <mat-icon aria-hidden="false" class="material-symbols-outlined"
                        matBadge="{{messageService.getSelectedMessages().at(-1)!.dislikes | shortNumber}}"
                        matBadgePosition="after" matBadgeColor="accent" matBadgeOverlap="true">thumb_down</mat-icon>
                </button>
                <button
                    *ngIf="user.id != messageService.getSelectedMessages().at(-1)?.userId && undefined == messageService.getSelectedMessages().at(-1)?.message && undefined == messageService.getSelectedMessages().at(-1)?.translatedMessage"
                    mat-mini-fab color="secondary" aria-label="Translate message"
                    (click)="translateMessage(messageService.getSelectedMessages().at(-1)!)">
                    <mat-icon>translate</mat-icon>
                </button>
                <button *ngIf="user.id != messageService.getSelectedMessages().at(-1)?.userId" mat-mini-fab
                    color="secondary" aria-label="Edit message"
                    (click)="editMessageUserProfile(messageService.getSelectedMessages().at(-1)!)">
                    <mat-icon aria-hidden="false" class="material-symbols-outlined">person</mat-icon>
                </button>
                <button *ngIf="user.id == messageService.getSelectedMessages().at(-1)?.userId" mat-mini-fab
                    color="secondary" aria-label="Edit message"
                    (click)="editMessage(messageService.getSelectedMessages().at(-1)!)">
                    <mat-icon aria-hidden="false" class="material-symbols-outlined">edit</mat-icon>
                </button>
                <button *ngIf="user.id == messageService.getSelectedMessages().at(-1)?.userId" mat-mini-fab
                    color="secondary" aria-label="Delete message"
                    (click)="deleteMessage(messageService.getSelectedMessages().at(-1)!)">
                    <mat-icon aria-hidden="false" class="material-symbols-outlined">delete_forever</mat-icon>
                </button>
                <button [matMenuTriggerFor]="messageMenu"
                    [matMenuTriggerData]="{user: user, message: messageService.getSelectedMessages().at(-1)!}"
                    aria-hidden="false" mat-mini-fab color="secondary" aria-label="Message menu" (click)="{}">
                    <mat-icon aria-hidden="false" class="material-symbols-outlined">more_vert</mat-icon>
                </button>
            </mat-card-actions>
        </mat-card>
        <div *ngIf="messageService.getSelectedMessages().at(-1)!.comments.length != 0">
            <mat-card class="item"
                *ngFor="let comment of messageService.getSelectedMessages().at(-1)?.comments; index as i">
                <img *ngIf="user.base64Avatar != '' && user.id == comment.userId" class="avatar"
                    src="{{user.base64Avatar}}" />
                <img *ngIf="profileService.getProfile(comment.userId)?.base64Avatar != '' && user.id != comment.userId"
                    class="avatar" src="{{profileService.getProfile(comment.userId)?.base64Avatar}}" />
                <button [attr.aria-hidden]="false" class="button_detail" mat-mini-fab color="secondary"
                    aria-label="Detial" (click)="goToMessageDetails(comment)">
                    <mat-icon [attr.aria-hidden]="false" class="material-symbols-outlined">expand_content</mat-icon>
                </button>
                <mat-card-header>
                    <mat-card-title *ngIf="user.id == comment.userId">{{user.name}}</mat-card-title>
                    <mat-card-title
                        *ngIf="user.id != comment.userId">{{profileService.getProfile(comment.userId)?.name}}</mat-card-title>
                    <mat-card-subtitle></mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                    <app-showmultimedia [multimedia]="comment.multimedia"></app-showmultimedia>
                    <app-showmessage
                        [message]="undefined != comment.translatedMessage ? comment.translatedMessage : comment.message"
                        [style]="comment.style"></app-showmessage>
                </mat-card-content>
            </mat-card>
        </div>
    </div>
</mat-dialog-content>

<mat-menu #messageMenu="matMenu">
    <ng-template matMenuContent let-user="user" let-message="message">
        <button mat-mini-fab color="secondary" aria-label="Fly to message" (click)="flyTo(message)">
            <mat-icon>place</mat-icon>
        </button>
        <button mat-mini-fab color="secondary" aria-label="Navigate to message location."
            (click)="navigateToMessageLocation(message)">
            <mat-icon>assistant_direction</mat-icon>
        </button>
        <button *ngIf="user.id != message.userId" mat-mini-fab color="secondary" aria-label="Block message"
            (click)="disableMessage(message)">
            <mat-icon aria-hidden="false" class="material-symbols-outlined">visibility_off</mat-icon>
        </button>
    </ng-template>
</mat-menu>