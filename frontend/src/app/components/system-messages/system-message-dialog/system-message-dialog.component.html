<h2 mat-dialog-title>
  @if (selectedNotification(); as detail) {
  <div class="dialog-title">
    <button mat-icon-button class="back-button" (click)="backToList()" aria-label="Back to system messages">
      <mat-icon class="material-symbols-outlined">arrow_back</mat-icon>
    </button>
    <span class="dialog-title__text">{{ detail.title }}</span>
  </div>
  } @else {
  <div class="dialog-title">
    <button mat-icon-button class="back-button" (click)="reloadNotifications()" aria-label="Back to system messages">
      <mat-icon class="material-symbols-outlined">refresh</mat-icon>
    </button>
    <span class="dialog-title__text">System messages</span>
  </div>
  }
</h2>

<mat-dialog-content>
  <div class="dialog-content">
    @if (!selectedNotification()) {
    <div class="filter-group">
      <mat-button-toggle-group [hideSingleSelectionIndicator]="true" class="filter-toggle-group" exclusive
        [value]="currentFilter()" (change)="handleFilterChange($event)" aria-label="Filter system messages">
        <mat-button-toggle value="unread">
          <mat-icon class="material-symbols-outlined">mark_email_unread</mat-icon>
          <span>Unread</span>
        </mat-button-toggle>
        <mat-button-toggle value="read">
          <mat-icon class="material-symbols-outlined">drafts</mat-icon>
          <span>Read</span>
        </mat-button-toggle>
        <mat-button-toggle value="all">
          <mat-icon class="material-symbols-outlined">all_inbox</mat-icon>
          <span>All</span>
        </mat-button-toggle>
      </mat-button-toggle-group>
    </div>
    }

    @if (loading()) {
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    }

    @if (selectedNotification(); as detail) {
    <div class="detail-view">
      <div class="detail-tile-grid">
        <div class="detail-tile detail-meta-item detail-meta-case">
          <span class="detail-meta-item__label">Case ID</span>
          <span class="detail-meta-item__value">
            {{ detail.metadata?.dsa?.caseId ?? 'n/a' }}
          </span>
        </div>
        <div class="detail-tile detail-meta-item detail-meta-actions">
          <span class="detail-meta-item__label">Actions</span>
          <div class="detail-actions" role="group" aria-label="Case actions">
            @if (detail.metadata?.dsa?.statusUrl) {
            <button mat-icon-button color="primary" matTooltip="Open case details"
              (click)="openStatusLink(detail.metadata?.dsa?.statusUrl, $event)" aria-label="Open case details">
              <mat-icon class="material-symbols-outlined">open_in_new</mat-icon>
            </button>
            }
            <button mat-icon-button color="accent"
              [matTooltip]="detail.status === 'unread' ? 'Mark as read' : 'Mark as unread'"
              (click)="detail.status === 'unread' ? markNotificationAsRead(detail, $event) : markNotificationAsUnread(detail, $event)"
              aria-label="Toggle read state">
              <mat-icon class="material-symbols-outlined">
                {{ detail.status === 'unread' ? 'mark_email_read' : 'mark_email_unread' }}
              </mat-icon>
            </button>
            <button mat-icon-button color="warn" matTooltip="Delete message" (click)="confirmDelete(detail, $event)"
              aria-label="Delete message">
              <mat-icon class="material-symbols-outlined">delete</mat-icon>
            </button>
          </div>
        </div>
      </div>
      <div class="detail-tile detail-body">
        <span class="detail-meta-item__label">Message</span>
        <span class="detail-meta-item__value">{{ detail.body }}</span>
      </div>

      <div class="detail-tile-grid">
        @if (detail.metadata?.reasonText) {
        <div class="detail-tile detail-meta-item">
          <span class="detail-meta-item__label">Reason</span>
          <span class="detail-meta-item__value">{{ detail.metadata?.reasonText }}</span>
        </div>
        }
        @if (detail.metadata?.category) {
        <div class="detail-tile detail-meta-item">
          <span class="detail-meta-item__label">Category</span>
          <span class="detail-meta-item__value">{{ detail.metadata?.category }}</span>
        </div>
        }
        @if (detail.metadata?.reportedContentType) {
        <div class="detail-tile detail-meta-item">
          <span class="detail-meta-item__label">Content type</span>
          <span class="detail-meta-item__value">{{ detail.metadata?.reportedContentType }}</span>
        </div>
        }
        <div class="detail-tile detail-meta-item detail-meta-status">
          <span class="detail-meta-item__label">Status</span>
          <div class="detail-status-wrapper">
            <span class="detail-status detail-status-text" [class.unread-text]="detail.status === 'unread'">
              {{ detail.status | titlecase }}
            </span>
            <span class="detail-meta-item__note">{{ (detail.createdAt * 1000) | date : 'medium' }}</span>
          </div>
        </div>
      </div>
    </div>
    } @else {
    <mat-nav-list class="notification-list">
      @if (notifications().length === 0 && !loading()) {
      <div class="empty-state">
        No system messages in this view.
      </div>
      } @else {
      @for (notification of notifications(); track trackByUuid($index, notification)) {
      <a mat-list-item class="notification-item" (click)="selectNotification(notification, $event)"
        [class.active]="selectedNotification()?.uuid === notification.uuid">
        <mat-icon class="material-symbols-outlined" matListItemIcon>
          {{ notification.status === 'unread' ? 'notifications_active' : 'notifications' }}
        </mat-icon>
        <div matLine class="notification-item__title">{{ notification.title }}</div>
        <div matLine class="notification-item__timestamp">
          {{ (notification.createdAt * 1000) | date : 'medium' }}
        </div>
        <div matListItemMeta class="notification-item__actions">
          @if (notification.metadata?.dsa?.statusUrl) {
          <button mat-icon-button color="primary" matTooltip="Open case details"
            (click)="openStatusLink(notification.metadata?.dsa?.statusUrl, $event)" aria-label="Open case details">
            <mat-icon class="material-symbols-outlined">open_in_new</mat-icon>
          </button>
          }
          @if (notification.status === 'unread') {
          <button mat-icon-button color="accent" matTooltip="Mark as read"
            (click)="markNotificationAsRead(notification, $event)" aria-label="Mark as read">
            <mat-icon class="material-symbols-outlined">mark_email_read</mat-icon>
          </button>
          } @else {
          <button mat-icon-button color="accent" matTooltip="Mark as unread"
            (click)="markNotificationAsUnread(notification, $event)" aria-label="Mark as unread">
            <mat-icon class="material-symbols-outlined">mark_email_unread</mat-icon>
          </button>
          }
          <button mat-icon-button color="warn" matTooltip="Delete message" (click)="confirmDelete(notification, $event)"
            aria-label="Delete message">
            <mat-icon class="material-symbols-outlined">delete</mat-icon>
          </button>
        </div>
      </a>
      }
      }
    </mat-nav-list>
    }
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
  @if (!selectedNotification()) {
  <button mat-button color="warn" matTooltip="Delete all" (click)="confirmDeleteAll($event)" aria-label="Delete all">
    Delete all
    <mat-icon class="material-symbols-outlined">delete_sweep</mat-icon>
  </button>
  }
  <button mat-button (click)="close()">Close</button>
</mat-dialog-actions>