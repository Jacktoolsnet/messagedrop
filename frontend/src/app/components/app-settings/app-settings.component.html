<app-dialog-header
  icon="settings"
  [title]="'settings.title' | transloco">
</app-dialog-header>
<mat-dialog-content class="settings-scroll">
  <div class="platform-tile-container">
    <div class="platform-tile theme-settings-tile">
      <div class="theme-settings-header">
        <mat-icon>palette</mat-icon>
        <div>
          <h3>{{ 'settings.theme.title' | transloco }}</h3>
          <p class="theme-settings-subtitle">{{ 'settings.theme.description' | transloco }}</p>
        </div>
      </div>

      <mat-form-field appearance="fill" class="theme-select">
        <mat-label>{{ 'settings.theme.label' | transloco }}</mat-label>
        <mat-select [value]="appSettings.defaultTheme" (selectionChange)="setTheme($event.value)">
          @for (theme of availableThemes; track theme) {
            <mat-option [value]="theme">
              {{ theme | titlecase }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-button-toggle-group [hideSingleSelectionIndicator]="true" [value]="appSettings.themeMode"
        (change)="setThemeMode($event.value)" class="theme-toggle-group" exclusive
        [attr.aria-label]="'settings.theme.modeLabel' | transloco">
        <mat-button-toggle value="light">
          <mat-icon>light_mode</mat-icon>
          {{ 'settings.theme.mode.light' | transloco }}
        </mat-button-toggle>
        <mat-button-toggle value="dark">
          <mat-icon>dark_mode</mat-icon>
          {{ 'settings.theme.mode.dark' | transloco }}
        </mat-button-toggle>
        <mat-button-toggle value="system">
          <mat-icon>settings</mat-icon>
          {{ 'settings.theme.mode.system' | transloco }}
        </mat-button-toggle>
      </mat-button-toggle-group>
    </div>

    <div class="platform-tile language-settings-tile">
      <div class="language-settings-header">
        <mat-icon>translate</mat-icon>
        <div>
          <h3>{{ 'settings.language.title' | transloco }}</h3>
          <p class="language-settings-subtitle">{{ 'settings.language.description' | transloco }}</p>
        </div>
      </div>

      <mat-button-toggle-group [hideSingleSelectionIndicator]="true" [value]="appSettings.languageMode"
        (change)="setLanguageMode($event.value)" class="language-toggle-group" exclusive
        [attr.aria-label]="'settings.language.title' | transloco">
        <mat-button-toggle value="system">
          <mat-icon>public</mat-icon>
          {{ 'settings.language.optionSystem' | transloco }}
        </mat-button-toggle>
        <mat-button-toggle value="en">
          <mat-icon>language</mat-icon>
          {{ 'settings.language.optionEnglish' | transloco }}
        </mat-button-toggle>
        <mat-button-toggle value="de">
          <mat-icon>language</mat-icon>
          {{ 'settings.language.optionGerman' | transloco }}
        </mat-button-toggle>
        <mat-button-toggle value="es">
          <mat-icon>language</mat-icon>
          {{ 'settings.language.optionSpanish' | transloco }}
        </mat-button-toggle>
        <mat-button-toggle value="fr">
          <mat-icon>language</mat-icon>
          {{ 'settings.language.optionFrench' | transloco }}
        </mat-button-toggle>
      </mat-button-toggle-group>
    </div>

    @if(showDetectLocationOnStart){
      <div class="platform-tile">
        <app-enable-location [checkedOverride]="appSettings.detectLocationOnStart" [persistOnToggle]="false"
          (enabledChange)="setDetectLocationOnStart($event)"></app-enable-location>
      </div>
    }
    @if(storagePersistenceSupported){
      <div class="platform-tile storage-persistence-tile">
      <div class="storage-persistence-header">
        <mat-icon>inventory_2</mat-icon>
        <div>
          <h3>{{ 'settings.storage.title' | transloco }}</h3>
          <p class="storage-persistence-subtitle">{{ 'settings.storage.description' | transloco }}</p>
        </div>
      </div>
      <p class="storage-persistence-note">
        {{ 'settings.storage.note' | transloco }}
      </p>
      <mat-slide-toggle color="primary" [checked]="appSettings.persistStorage"
          (change)="onStoragePersistenceToggle($event)" [disabled]="storagePersistenceBusy">
          {{ 'settings.storage.toggle' | transloco }}
      </mat-slide-toggle>
      @if(storagePersistenceBusy){
          <small class="storage-persistence-hint">{{ 'settings.storage.applying' | transloco }}</small>
      }
      @if(storagePersistenceWarning){
          <p class="storage-persistence-warning">{{ storagePersistenceWarning }}</p>
      }
      @if(storageQuotaWarning){
          <p class="storage-persistence-warning">{{ storageQuotaWarning }}</p>
      }
      </div>
    }
    <div class="platform-tile usage-protection-tile">
      <div class="usage-protection-header">
        <mat-icon>timer</mat-icon>
        <div>
          <h3>{{ 'settings.usageProtection.title' | transloco }}</h3>
          <p class="usage-protection-subtitle">{{ 'settings.usageProtection.description' | transloco }}</p>
        </div>
      </div>
      <p class="usage-protection-note">
        {{ 'settings.usageProtection.note' | transloco }}
      </p>

      @if (needsUsageProtectionUnlock()) {
      <p class="usage-protection-pin-state">
        {{ 'settings.usageProtection.unlockRequired' | transloco }}
      </p>
      <button mat-stroked-button type="button" (click)="unlockUsageProtectionSettings()">
        {{ 'settings.usageProtection.unlockAction' | transloco }}
      </button>
      } @else {
      <mat-button-toggle-group [hideSingleSelectionIndicator]="true" [value]="appSettings.usageProtection.mode"
        (change)="setUsageMode($event.value)" class="usage-mode-toggle-group" exclusive
        [attr.aria-label]="'settings.usageProtection.modeLabel' | transloco">
        @for (mode of usageModes; track mode) {
        <mat-button-toggle [value]="mode">
          {{ ('settings.usageProtection.mode.' + mode) | transloco }}
        </mat-button-toggle>
        }
      </mat-button-toggle-group>

      @if (appSettings.usageProtection.mode !== 'off') {
      <section class="usage-slider-block">
        <div class="usage-slider-header">
          <p class="usage-slider-label">{{ 'settings.usageProtection.dailyLimit' | transloco }}</p>
          <button mat-icon-button type="button" class="usage-slider-edit-button" (click)="openUsageDailyLimitEditor()"
            [attr.aria-label]="('common.actions.edit' | transloco) + ' ' + ('settings.usageProtection.dailyLimit' | transloco)">
            <mat-icon>edit</mat-icon>
          </button>
        </div>
        <mat-slider [min]="usageDailyLimitMin" [max]="usageDailyLimitMax" [step]="usageDailyLimitStep" discrete>
          <input matSliderThumb [value]="appSettings.usageProtection.dailyLimitMinutes"
            (valueChange)="setUsageDailyLimitMinutes($event)">
        </mat-slider>
        <p class="usage-slider-value">{{ appSettings.usageProtection.dailyLimitMinutes }}</p>
      </section>

      @if (appSettings.usageProtection.mode === 'self') {
      <section class="usage-slider-block">
        <div class="usage-slider-header">
          <p class="usage-slider-label">{{ 'settings.usageProtection.selfExtension' | transloco }}</p>
          <button mat-icon-button type="button" class="usage-slider-edit-button" (click)="openUsageSelfExtensionEditor()"
            [attr.aria-label]="('common.actions.edit' | transloco) + ' ' + ('settings.usageProtection.selfExtension' | transloco)">
            <mat-icon>edit</mat-icon>
          </button>
        </div>
        <mat-slider [min]="usageSelfExtensionMin" [max]="usageSelfExtensionMax" [step]="usageSelfExtensionStep" discrete>
          <input matSliderThumb [value]="appSettings.usageProtection.selfExtensionMinutes"
            (valueChange)="setUsageSelfExtensionMinutes($event)">
        </mat-slider>
        <p class="usage-slider-value">{{ appSettings.usageProtection.selfExtensionMinutes }}</p>
      </section>
      }

      @if (appSettings.usageProtection.mode === 'parental') {
      <section class="usage-slider-block">
        <div class="usage-slider-header">
          <p class="usage-slider-label">{{ 'settings.usageProtection.parentalExtension' | transloco }}</p>
          <button mat-icon-button type="button" class="usage-slider-edit-button" (click)="openUsageParentalExtensionEditor()"
            [attr.aria-label]="('common.actions.edit' | transloco) + ' ' + ('settings.usageProtection.parentalExtension' | transloco)">
            <mat-icon>edit</mat-icon>
          </button>
        </div>
        <mat-slider [min]="usageParentalExtensionMin" [max]="usageParentalExtensionMax" [step]="usageParentalExtensionStep" discrete>
          <input matSliderThumb [value]="appSettings.usageProtection.parentalExtensionMinutes"
            (valueChange)="setUsageParentalExtensionMinutes($event)">
        </mat-slider>
        <p class="usage-slider-value">{{ appSettings.usageProtection.parentalExtensionMinutes }}</p>
      </section>
      }

      <mat-slide-toggle color="primary" [checked]="appSettings.usageProtection.scheduleEnabled"
        (change)="setUsageScheduleEnabled($event.checked)">
        {{ 'settings.usageProtection.scheduleToggle' | transloco }}
      </mat-slide-toggle>

      @if (appSettings.usageProtection.scheduleEnabled) {
      <div class="usage-time-grid">
        <mat-form-field appearance="fill">
          <mat-label>{{ 'settings.usageProtection.weekdayStart' | transloco }}</mat-label>
          <input matInput type="time" [ngModel]="appSettings.usageProtection.weekdayStart"
            (ngModelChange)="setUsageWeekdayStart($event)">
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>{{ 'settings.usageProtection.weekdayEnd' | transloco }}</mat-label>
          <input matInput type="time" [ngModel]="appSettings.usageProtection.weekdayEnd"
            (ngModelChange)="setUsageWeekdayEnd($event)">
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>{{ 'settings.usageProtection.weekendStart' | transloco }}</mat-label>
          <input matInput type="time" [ngModel]="appSettings.usageProtection.weekendStart"
            (ngModelChange)="setUsageWeekendStart($event)">
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>{{ 'settings.usageProtection.weekendEnd' | transloco }}</mat-label>
          <input matInput type="time" [ngModel]="appSettings.usageProtection.weekendEnd"
            (ngModelChange)="setUsageWeekendEnd($event)">
        </mat-form-field>
      </div>
      }
      }

      @if (appSettings.usageProtection.mode === 'parental') {
      <p class="usage-protection-pin-state">
        @if (usageParentPin) {
        {{ 'settings.usageProtection.pinPending' | transloco }}
        } @else if (appSettings.usageProtection.parentPinHash) {
        {{ 'settings.usageProtection.pinSet' | transloco }}
        } @else {
        {{ 'settings.usageProtection.pinMissing' | transloco }}
        }
      </p>
      <button mat-stroked-button type="button" (click)="openUsageParentPinDialog()">
        @if (appSettings.usageProtection.parentPinHash) {
        {{ 'settings.usageProtection.pinChangeAction' | transloco }}
        } @else {
        {{ 'settings.usageProtection.pinSetAction' | transloco }}
        }
      </button>
      }

      @if (hasConfiguredParentPin()) {
      <button mat-stroked-button type="button" (click)="removeUsageParentPin()">
        {{ 'settings.usageProtection.pinDeleteAction' | transloco }}
      </button>
      }
      }

      @if (usageProtectionWarning) {
      <p class="usage-protection-warning">{{ usageProtectionWarning }}</p>
      }
    </div>
    <div class="platform-tile logging-settings-tile">
      <div class="logging-settings-header">
        <mat-icon>bug_report</mat-icon>
        <div>
          <h3>{{ 'settings.logging.title' | transloco }}</h3>
          <p class="logging-settings-subtitle">{{ 'settings.logging.description' | transloco }}</p>
        </div>
      </div>
      <p class="logging-settings-note">
        {{ 'settings.logging.note' | transloco }}
      </p>
      <mat-slide-toggle color="primary" [checked]="appSettings.diagnosticLogging"
        (change)="setDiagnosticLogging($event.checked)">
        {{ 'settings.logging.toggle' | transloco }}
      </mat-slide-toggle>
    </div>
    <div class="platform-tile backup-exit-tile">
      <div class="backup-exit-header">
        <mat-icon>save</mat-icon>
        <div>
          <h3>{{ 'settings.backup.title' | transloco }}</h3>
          <p class="backup-exit-subtitle">{{ 'settings.backup.description' | transloco }}</p>
        </div>
      </div>
      <p class="backup-exit-note">
        {{ 'settings.backup.note' | transloco }}
      </p>
      <mat-slide-toggle color="primary" [checked]="appSettings.backupOnExit"
        (change)="setBackupOnExit($event.checked)">
        {{ 'settings.backup.toggle' | transloco }}
      </mat-slide-toggle>
    </div>
    <div class="platform-tile version-info-tile">
      <div class="version-info-header">
        <mat-icon>info</mat-icon>
        <div>
          <h3>{{ 'settings.versionLabel' | transloco }}</h3>
          <p class="version-info-value">
            {{ versionInfo.semver }}-{{ versionInfo.build }}-{{ versionInfo.commit }}-{{ versionInfo.timestamp }}
          </p>
        </div>
      </div>
    </div>
  </div>

</mat-dialog-content>
<mat-dialog-actions class="sticky-actions" align="end">
  <button mat-dialog-close cdkFocusInitial (click)="onCloseClick()" mat-icon-button
    [attr.aria-label]="'common.actions.close' | transloco" class="action-close">
    <mat-icon>close</mat-icon>
  </button>
  <button mat-icon-button type="button" (click)="help.open('appSettings')"
    [attr.aria-label]="'common.actions.help' | transloco">
    <mat-icon>help</mat-icon>
  </button>
  <button mat-icon-button color="primary" [attr.aria-label]="'common.actions.apply' | transloco"
    (click)="onApplyClick()" [disabled]="storagePersistenceBusy">
    <mat-icon>check</mat-icon>
  </button>
</mat-dialog-actions>
