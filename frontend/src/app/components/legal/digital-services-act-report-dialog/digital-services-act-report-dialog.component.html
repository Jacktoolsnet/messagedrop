<app-dialog-header
  [title]="'dsa.report.title' | transloco">
</app-dialog-header>

<mat-dialog-content>
  <p class="intro">
    {{ 'dsa.report.intro.start' | transloco }}
    <strong>{{ 'dsa.report.intro.quick' | transloco }}</strong>
    {{ 'dsa.report.intro.middle' | transloco }}
    <strong>{{ 'dsa.report.intro.formal' | transloco }}</strong>
    {{ 'dsa.report.intro.end' | transloco }}
    <em>{{ 'dsa.report.intro.emphasis' | transloco }}</em>.
    {{ 'dsa.report.intro.tail' | transloco }}
  </p>

  <!-- Message-Preview -->
  <section class="message-preview" [attr.aria-label]="'dsa.report.meta.reportedContent' | transloco">
    <div class="meta">
      <div class="meta-row">
        <span class="meta-label">{{ 'dsa.report.meta.contentId' | transloco }}</span>
        <span class="meta-value">{{ quickForm.get('contentId')?.value }}</span>
      </div>
      @if (data.contentUrl) {
        <div class="meta-row">
          <span class="meta-label">{{ 'dsa.report.meta.link' | transloco }}</span>
          <span class="meta-value url">{{ data.contentUrl }}</span>
        </div>
      }
    </div>
  </section>

  <mat-tab-group [(selectedIndex)]="activeTabIndex">
    <!-- TAB 1: QUICK REPORT -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>flag</mat-icon>
        <span class="tab-label">{{ 'dsa.report.tabs.quick' | transloco }}</span>
      </ng-template>

      <div class="tab-explainer"></div>

      <form [formGroup]="quickForm" class="dialog-grid">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>{{ 'dsa.report.fields.categoryLabel' | transloco }}</mat-label>
          <mat-select formControlName="category">
            @for (c of categories; track c.value) {
              <mat-option [value]="c.value">{{ c.labelKey | transloco }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>{{ 'dsa.report.fields.reasonLabelQuick' | transloco }}</mat-label>
          <textarea matInput formControlName="reasonText" rows="5"
          [placeholder]="'dsa.report.fields.reasonPlaceholderQuick' | transloco"></textarea>
        </mat-form-field>
      </form>
    </mat-tab>

    <!-- TAB 2: FORMAL DSA REPORT -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>gavel</mat-icon>
        <span class="tab-label">{{ 'dsa.report.tabs.formal' | transloco }}</span>
      </ng-template>

      <div class="tab-explainer"></div>

      <form [formGroup]="formalForm" class="dialog-grid">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>{{ 'dsa.report.fields.categoryLabel' | transloco }}</mat-label>
          <mat-select formControlName="category">
            @for (c of categories; track c.value) {
              <mat-option [value]="c.value">{{ c.labelKey | transloco }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>{{ 'dsa.report.fields.reasonLabelFormal' | transloco }}</mat-label>
          <textarea matInput formControlName="reasonText" rows="6"
          [placeholder]="'dsa.report.fields.reasonPlaceholderFormal' | transloco"></textarea>
        </mat-form-field>

        <div class="row two-cols">
          <mat-form-field appearance="outline" class="half">
            <mat-label>{{ 'dsa.report.fields.emailLabel' | transloco }}</mat-label>
            <input matInput formControlName="reporterEmail" type="email" inputmode="email"
              autocomplete="email" />

            <mat-hint align="start">
              {{
              (formalForm.get('reporterEmail')?.value || '').trim()
              ? ('dsa.report.fields.emailHintProvided' | transloco:{ email: formalForm.get('reporterEmail')?.value })
              : ('dsa.report.fields.emailHintMissing' | transloco)
              }}
            </mat-hint>

            @if (isFormalEmailInvalid) {
              <mat-error>
                {{ 'dsa.report.fields.emailInvalid' | transloco }}
              </mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'dsa.report.fields.nameLabel' | transloco }}</mat-label>
            <input matInput formControlName="reporterName" [placeholder]="'dsa.report.fields.namePlaceholder' | transloco">
          </mat-form-field>
        </div>

        <mat-checkbox formControlName="truthAffirmation">
          {{ 'dsa.report.fields.truthAffirmation' | transloco }}
        </mat-checkbox>

        <div class="url-upload">
          <app-evidence-input [showUrl]="true" [showFiles]="true" [disabled]="submitting"
            [urlItems]="evidenceUrlViews()"
            [fileItems]="evidenceFileViews()"
            [fileHint]="'dsa.report.evidence.hint' | transloco:{ size: evidenceFilesSizeLabel(), count: evidenceFileViews().length, max: maxEvidenceFiles }"
            (urlAdd)="addEvidenceUrlFromInput($event)"
            (filesSelect)="onEvidenceFilesPicked($event)"
            (urlRemove)="removeEvidenceById($event)"
          (fileRemove)="removeEvidenceById($event)"></app-evidence-input>
        </div>
      </form>
    </mat-tab>
  </mat-tab-group>

  @if (errorMsg) {
    <div class="error" role="alert">{{ errorMsg }}</div>
  }
</mat-dialog-content>

<mat-dialog-actions class="sticky-actions" align="end">
  <button (click)="cancel()" [disabled]="submitting" mat-icon-button [attr.aria-label]="'common.cancel' | transloco" class="action-close"><mat-icon>close</mat-icon></button>
  <button mat-icon-button type="button" (click)="help.open('dsaReport')"
    [attr.aria-label]="'common.actions.help' | transloco">
    <mat-icon>help</mat-icon>
  </button>
  <button color="primary" (click)="submit()" [disabled]="submitting || (activeTabIndex===1 && isFormalEmailInvalid)" mat-icon-button [attr.aria-label]="'dsa.report.submitButton' | transloco"><mat-icon>send</mat-icon></button>
</mat-dialog-actions>
