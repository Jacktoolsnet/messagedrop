<h2 mat-dialog-title>Report content</h2>

<mat-dialog-content>
    <p class="intro">
        Reporting should be easy. You can submit a <strong>Quick report</strong> (informal signal)
        or a <strong>Formal DSA report</strong> (notice under the EU Digital Services Act) —
        <em>no fields are mandatory</em>. We’ll review the post either way.
    </p>

    <!-- Message-Preview -->
    <section class="message-preview" aria-label="Reported content">
        <div class="meta">
            <div class="meta-row">
                <span class="meta-label">Content ID</span>
                <span class="meta-value">{{ quickForm.get('contentId')?.value }}</span>
            </div>
            @if (data.reportedContentUrl) {
            <div class="meta-row">
                <span class="meta-label">Link</span>
                <span class="meta-value url">{{ data.reportedContentUrl }}</span>
            </div>
            }
        </div>
    </section>

    <mat-tab-group [(selectedIndex)]="activeTabIndex">
        <!-- TAB 1: QUICK REPORT -->
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon>flag</mat-icon>
                <span class="tab-label">Quick report</span>
            </ng-template>

            <div class="tab-explainer"></div>

            <form [formGroup]="quickForm" class="dialog-grid">
                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Category (optional)</mat-label>
                    <mat-select formControlName="category">
                        @for (c of categories; track c.value) {
                        <mat-option [value]="c.value">{{ c.label }}</mat-option>
                        }
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Why is this content problematic? (optional)</mat-label>
                    <textarea matInput formControlName="reasonText" rows="5"
                        placeholder="Share any details that help us understand the issue..."></textarea>
                </mat-form-field>
            </form>
        </mat-tab>

        <!-- TAB 2: FORMAL DSA REPORT -->
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon>gavel</mat-icon>
                <span class="tab-label">Formal DSA report</span>
            </ng-template>

            <div class="tab-explainer"></div>

            <form [formGroup]="formalForm" class="dialog-grid">
                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Category (optional)</mat-label>
                    <mat-select formControlName="category">
                        @for (c of categories; track c.value) {
                        <mat-option [value]="c.value">{{ c.label }}</mat-option>
                        }
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Why is this content illegal? (optional)</mat-label>
                    <textarea matInput formControlName="reasonText" rows="6"
                        placeholder="Describe the issue and provide any relevant facts or references..."></textarea>
                </mat-form-field>

                <div class="row two-cols">
                    <mat-form-field appearance="outline" class="half">
                        <mat-label>Your email (optional)</mat-label>
                        <input matInput formControlName="reporterEmail" type="email" inputmode="email"
                            autocomplete="email" />

                        <mat-hint align="start">
                            {{
                            (formalForm.get('reporterEmail')?.value || '').trim()
                            ? ('We will notify you at ' + formalForm.get('reporterEmail')?.value)
                            : 'We can only notify you if you provide an email.'
                            }}
                        </mat-hint>

                        <mat-error *ngIf="isFormalEmailInvalid">
                            Please enter a valid email address or leave this field empty.
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Your name (optional)</mat-label>
                        <input matInput formControlName="reporterName" placeholder="Jane Doe">
                    </mat-form-field>
                </div>

                <mat-checkbox formControlName="truthAffirmation">
                    I declare that the information provided is accurate to the best of my knowledge. (optional)
                </mat-checkbox>
            </form>
        </mat-tab>

        <!-- TAB 3: EVIDENCE -->
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon>attach_file</mat-icon>
                <span class="tab-label">Evidence</span>
            </ng-template>

            <div class="tab-explainer">
                You can optionally attach evidence now. Files (images or PDF up to 5 MB) or URLs.
                They will be linked to your {{ activeTabIndex===0 ? 'report' : 'notice' }} after submission.
            </div>

            <div class="evidence-grid">
                <div class="evidence-section">
                    <div class="section-title">Files</div>
                    <div class="file-upload">
                        <label class="upload-label" for="ev-file">
                            <mat-icon>upload_file</mat-icon>
                            <span>Select file(s)</span>
                        </label>
                        <input id="ev-file" type="file" (change)="onEvidenceFileChange($event)" accept=".pdf,image/*" multiple />
                        <div class="muted">Allowed: PDF or images, each ≤ 5 MB</div>
                    </div>
                </div>

                <div class="evidence-section">
                    <div class="section-title">Add by URL</div>
                    <form [formGroup]="evidenceForm" class="row">
                        <mat-form-field appearance="outline" class="w-full">
                            <mat-label>Evidence URL</mat-label>
                            <input matInput formControlName="url" placeholder="https://…" />
                        </mat-form-field>
                        <button mat-stroked-button type="button" (click)="addEvidenceUrl()">
                            <mat-icon>add_link</mat-icon>
                            Add URL
                        </button>
                    </form>
                </div>

                

                <div class="evidence-list" *ngIf="evidenceItems().length > 0">
                    <div class="list-title">Selected evidence</div>
                    <div class="chips">
                        @for (e of evidenceItems(); track e.id; let i = $index) {
                        <mat-chip-row>
                            <mat-icon>{{ e.type === 'file' ? 'description' : (e.type === 'url' ? 'link' : 'fingerprint') }}</mat-icon>
                            <span class="chip-text">
                                @if (e.type === 'file') { {{ e.file?.name }} }
                                @if (e.type === 'url') { {{ e.url }} }
                            </span>
                            <button matChipRemove (click)="removeEvidence(i)" aria-label="Remove">
                                <mat-icon>close</mat-icon>
                            </button>
                        </mat-chip-row>
                        }
                    </div>
                </div>
            </div>
        </mat-tab>
    </mat-tab-group>

    @if (errorMsg) {
    <div class="error" role="alert">{{ errorMsg }}</div>
    }
</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-button (click)="cancel()" [disabled]="submitting">Cancel</button>
    <button color="primary" mat-flat-button (click)="submit()"
        [disabled]="submitting || (activeTabIndex===1 && isFormalEmailInvalid)">
        <mat-icon>send</mat-icon>
        Submit
    </button>
</mat-dialog-actions>
