<h2 mat-dialog-title class="dialog-title">
  {{ 'dsa.case.title' | transloco }}
</h2>

<mat-dialog-content class="dialog-content">
  @if (!loading()) {
  @if (error()) {
  <mat-card class="error-card">
    <mat-icon>error</mat-icon>
    <div>
      <h3>{{ 'dsa.case.loadLatestFailed' | transloco }}</h3>
      <p>{{ error() }}</p>
    </div>
  </mat-card>
  } @else {
  <mat-tab-group disableRipple class="case-tabs" [selectedIndex]="activeTab()"
    (selectedIndexChange)="activeTab.set($event)">
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>info</mat-icon>
        <span>{{ 'dsa.case.tabs.overview' | transloco }}</span>
      </ng-template>

      @if (status(); as caseData) {
      <div class="tab-body">
        <div class="tile-grid">
          <mat-card class="tile-card">
            <mat-card-title>{{ 'dsa.case.summary.title' | transloco }}</mat-card-title>
            <mat-card-content>
              <dl>
                <div>
                  <dt>{{ 'dsa.case.summary.status' | transloco }}</dt>
                  <dd>{{ summaryStatusLabel() }}</dd>
                </div>
                <div>
                  <dt>{{ 'dsa.case.summary.contentId' | transloco }}</dt>
                  <dd>{{ summaryContentId() }}</dd>
                </div>
                <div>
                  <dt>{{ 'dsa.case.summary.submitted' | transloco }}</dt>
                  @if (summarySubmittedAt(); as submittedAt) {
                  <dd>{{ submittedAt | date:'medium' }}</dd>
                  } @else {
                  <dd>—</dd>
                  }
                </div>
              </dl>
            </mat-card-content>
          </mat-card>

          @if (isSignal()) {
          <mat-card class="tile-card">
            <mat-card-title>{{ 'dsa.case.reportDetails.title' | transloco }}</mat-card-title>
            <mat-card-content>
              <dl>
                <div>
                  <dt>{{ 'dsa.case.reportDetails.type' | transloco }}</dt>
                  <dd>{{ signalContentType() || ('dsa.case.contentType.publicMessage' | transloco) }}</dd>
                </div>
                <div>
                  <dt>{{ 'dsa.case.reportDetails.category' | transloco }}</dt>
                  <dd>{{ signalCategory() || '—' }}</dd>
                </div>
                <div>
                  <dt>{{ 'dsa.case.reportDetails.reason' | transloco }}</dt>
                  <dd class="statement">{{ signalReason() || '—' }}</dd>
                </div>
                @if (signalContentUrl()) {
                <div>
                  <dt>{{ 'dsa.case.reportDetails.link' | transloco }}</dt>
                  <dd class="statement">{{ signalContentUrl() }}</dd>
                </div>
                }
              </dl>
            </mat-card-content>
          </mat-card>
          }

          @if (isNotice() && caseData.decision; as decision) {
          <mat-card class="tile-card">
            <mat-card-title>{{ 'dsa.case.decision.title' | transloco }}</mat-card-title>
            <mat-card-content>
              <dl>
                <div>
                  <dt>{{ 'dsa.case.decision.outcome' | transloco }}</dt>
                  <dd>{{ decision.outcome }}</dd>
                </div>
                @if (decision.decidedAt) {
                <div>
                  <dt>{{ 'dsa.case.decision.reviewedOn' | transloco }}</dt>
                  <dd>{{ decision.decidedAt | date:'medium' }}</dd>
                </div>
                }
                @if (decision.statement) {
                <div>
                  <dt>{{ 'dsa.case.decision.statement' | transloco }}</dt>
                  <dd class="statement">{{ decision.statement }}</dd>
                </div>
                }
              </dl>
            </mat-card-content>
          </mat-card>
          }

          @if (isNotice() && evidence().length > 0) {
          <mat-card class="tile-card">
            <mat-card-title>{{ 'dsa.case.evidence.title' | transloco }}</mat-card-title>
            <mat-card-content class="appeals-stack">
              @for (ev of evidence(); track ev.id) {
              <section class="appeal-block evidence-block">
                <header>
                  <div class="appeal-meta">
                    <span class="label">{{ 'dsa.case.evidence.label' | transloco }}</span>
                    <span>{{ ev.fileName || ev.url || ev.hash || ev.type }}</span>
                  </div>
                  <div class="status-chip">
                    {{
                    ev.type === 'file'
                    ? ('dsa.case.evidence.type.file' | transloco)
                    : ev.type === 'url'
                      ? ('dsa.case.evidence.type.link' | transloco)
                      : ev.type
                    }}
                  </div>
                </header>

                @if (ev.addedAt) {
                <div class="evidence-meta">
                  {{ 'dsa.case.evidence.added' | transloco }} {{ ev.addedAt | date:'medium' }}
                </div>
                }

                <div class="evidence-actions">
                  @if (ev.type === 'file') {
                  <button mat-stroked-button color="primary" type="button" (click)="download(ev)">
                    <mat-icon>download</mat-icon>
                    {{ 'dsa.case.evidence.download' | transloco }}
                  </button>
                  }
                  @if (ev.type === 'url' && ev.url) {
                  <a mat-stroked-button color="primary" [href]="ev.url" target="_blank" rel="noopener" role="button">
                    <mat-icon>open_in_new</mat-icon>
                    {{ 'dsa.case.evidence.openLink' | transloco }}
                  </a>
                  }
                  @if (ev.type === 'hash' && ev.hash) {
                  <span class="hash-value">{{ 'dsa.case.evidence.hash' | transloco }}: {{ ev.hash }}</span>
                  }
                </div>
              </section>
              }
            </mat-card-content>
          </mat-card>
          }

          @if (isNotice() && appeals().length > 0) {
          <mat-card class="tile-card">
            <mat-card-title>{{ 'dsa.case.appeals.title' | transloco }}</mat-card-title>
            <mat-card-content class="appeals-stack">
              @for (appeal of appeals(); track appeal.id) {
              <section class="appeal-block">
                <header>
                  <div class="appeal-meta">
                    <span class="label">{{ 'dsa.case.appeals.label' | transloco }}</span>
                    <span>{{ 'dsa.case.appeals.filed' | transloco }} {{ appeal.filedAt | date:'medium' }}</span>
                  </div>
                  <div class="status-chip" [ngClass]="{ 'resolved': !!appeal.resolvedAt, 'open': !appeal.resolvedAt }">
                    {{ formatAppealOutcome(appeal.outcome) }}
                  </div>
                </header>

                <div class="appeal-content">
                  <h4>{{ 'dsa.case.appeals.arguments' | transloco }}</h4>
                  <p>{{ appeal.arguments }}</p>
                </div>

                @if (appeal.resolvedAt) {
                <footer>
                  <div class="decision-meta">
                    <span class="label">{{ 'dsa.case.appeals.decision' | transloco }}</span>
                    <span>{{ 'dsa.case.appeals.resolved' | transloco }} {{ appeal.resolvedAt | date:'medium' }}</span>
                    @if (appeal.reviewer) {
                    <span>{{ 'dsa.case.appeals.reviewer' | transloco }}: {{ appeal.reviewer }}</span>
                    }
                  </div>
                </footer>
                }
              </section>
              }
            </mat-card-content>
          </mat-card>
          }
        </div>
      </div>
      }
    </mat-tab>

    @if (canSubmitAppeal()) {
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>rate_review</mat-icon>
        <span>{{ 'dsa.case.tabs.submitAppeal' | transloco }}</span>
      </ng-template>

      <div class="tab-body">
        <p class="appeal-hint">
          {{ 'dsa.case.appealHint' | transloco }}
        </p>

        <form id="appeal-form" [formGroup]="appealForm" (ngSubmit)="submitAppeal()" class="appeal-form">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'dsa.case.appealForm.explanationLabel' | transloco }}</mat-label>
            <textarea matInput rows="4" formControlName="arguments" required></textarea>
            <mat-hint align="end">{{ 'dsa.case.appealForm.minimumHint' | transloco }}</mat-hint>
            @if (appealForm.controls.arguments.invalid && appealForm.controls.arguments.touched) {
            <mat-error>
              {{ 'dsa.case.appealForm.error' | transloco }}
            </mat-error>
            }
          </mat-form-field>

          <div class="url-upload">
            <app-evidence-input [showUrl]="true" [showFiles]="true" [disabled]="submitting() || uploading()"
              [urlItems]="appealUrlViews()" [fileItems]="attachmentViews()"
              [fileHint]="'dsa.case.appealForm.fileHint' | transloco:{ size: attachmentsSizeLabel(), count: attachments().length, max: maxFiles }"
              (urlAdd)="onAppealUrlAdd($event)" (filesSelect)="onAttachmentsPicked($event)"
              (urlRemove)="onAppealUrlRemove($event)" (fileRemove)="onAttachmentRemove($event)"></app-evidence-input>
          </div>
        </form>
      </div>
    </mat-tab>
    }
  </mat-tab-group>
  }
  } @else {
  <div class="loading">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    <p>{{ 'dsa.case.loading' | transloco }}</p>
  </div>
  }
</mat-dialog-content>

<mat-dialog-actions class="sticky-actions" align="end">
  <button color="primary" (click)="close()" mat-icon-button [attr.aria-label]="'common.actions.close' | transloco" class="action-close"><mat-icon>close</mat-icon></button>
  @if (!loading() && !error() && activeTab() === 0) {
  <button color="primary" (click)="openPublicStatus()" [disabled]="!publicStatusUrl()" mat-icon-button [attr.aria-label]="'dsa.case.openPublicPage' | transloco"><mat-icon>open_in_new</mat-icon></button>
  }
  @if (!loading() && !error() && canSubmitAppeal() && activeTab() === 1) {
  <button color="primary" type="submit" form="appeal-form" [disabled]="submitting() || uploading()" mat-icon-button [attr.aria-label]="'dsa.case.submitAppeal' | transloco"><mat-icon>send</mat-icon></button>
  }
</mat-dialog-actions>
