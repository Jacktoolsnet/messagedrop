<h2 mat-dialog-title>
  Moderation status
</h2>

<mat-dialog-content class="dialog-content">
  @if (!loading()) {
  @if (error()) {
  <mat-card class="error-card">
    <mat-icon class="material-symbols-outlined">error</mat-icon>
    <div>
      <h3>We could not load the latest information.</h3>
      <p>{{ error() }}</p>
    </div>
  </mat-card>
  } @else {
  <mat-tab-group disableRipple class="case-tabs" [selectedIndex]="activeTab()"
    (selectedIndexChange)="activeTab.set($event)">
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="material-symbols-outlined">info</mat-icon>
        <span>Overview</span>
      </ng-template>

      @if (status(); as caseData) {
      <div class="tab-body">
        <div class="tile-grid">
          <mat-card class="tile-card">
            <mat-card-title>Case summary</mat-card-title>
            <mat-card-content>
              <dl>
                <div>
                  <dt>Status</dt>
                  <dd>{{ summaryStatusLabel() }}</dd>
                </div>
                <div>
                  <dt>Content ID</dt>
                  <dd>{{ summaryContentId() }}</dd>
                </div>
                <div>
                  <dt>Submitted</dt>
                  @if (summarySubmittedAt(); as submittedAt) {
                  <dd>{{ submittedAt | date:'medium' }}</dd>
                  } @else {
                  <dd>—</dd>
                  }
                </div>
              </dl>
            </mat-card-content>
          </mat-card>

          @if (isSignal()) {
          <mat-card class="tile-card">
            <mat-card-title>Report details</mat-card-title>
            <mat-card-content>
              <dl>
                <div>
                  <dt>Type</dt>
                  <dd>{{ signalContentType() || 'public message' }}</dd>
                </div>
                <div>
                  <dt>Category</dt>
                  <dd>{{ signalCategory() || '—' }}</dd>
                </div>
                <div>
                  <dt>Reason</dt>
                  <dd class="statement">{{ signalReason() || '—' }}</dd>
                </div>
                @if (signalContentUrl()) {
                <div>
                  <dt>Content link</dt>
                  <dd class="statement">{{ signalContentUrl() }}</dd>
                </div>
                }
              </dl>
            </mat-card-content>
          </mat-card>
          }

          @if (isNotice() && caseData.decision; as decision) {
          <mat-card class="tile-card">
            <mat-card-title>Decision</mat-card-title>
            <mat-card-content>
              <dl>
                <div>
                  <dt>Outcome</dt>
                  <dd>{{ decision.outcome }}</dd>
                </div>
                @if (decision.decidedAt) {
                <div>
                  <dt>Reviewed on</dt>
                  <dd>{{ decision.decidedAt | date:'medium' }}</dd>
                </div>
                }
                @if (decision.statement) {
                <div>
                  <dt>Statement</dt>
                  <dd class="statement">{{ decision.statement }}</dd>
                </div>
                }
              </dl>
            </mat-card-content>
          </mat-card>
          }

          @if (isNotice() && evidence().length > 0) {
          <mat-card class="tile-card">
            <mat-card-title>Evidence collected</mat-card-title>
            <mat-card-content class="appeals-stack">
              @for (ev of evidence(); track ev.id) {
              <section class="appeal-block evidence-block">
                <header>
                  <div class="appeal-meta">
                    <span class="label">Evidence</span>
                    <span>{{ ev.fileName || ev.url || ev.hash || ev.type }}</span>
                  </div>
                  <div class="status-chip">
                    {{ ev.type === 'file' ? 'File' : ev.type === 'url' ? 'Link' : ev.type }}
                  </div>
                </header>

                @if (ev.addedAt) {
                <div class="evidence-meta">
                  Added {{ ev.addedAt | date:'medium' }}
                </div>
                }

                <div class="evidence-actions">
                  @if (ev.type === 'file') {
                  <button mat-stroked-button color="primary" type="button" (click)="download(ev)">
                    <mat-icon class="material-symbols-outlined">download</mat-icon>
                    Download file
                  </button>
                  }
                  @if (ev.type === 'url' && ev.url) {
                  <a mat-stroked-button color="primary" [href]="ev.url" target="_blank" rel="noopener" role="button">
                    <mat-icon class="material-symbols-outlined">open_in_new</mat-icon>
                    Open link
                  </a>
                  }
                  @if (ev.type === 'hash' && ev.hash) {
                  <span class="hash-value">Hash: {{ ev.hash }}</span>
                  }
                </div>
              </section>
              }
            </mat-card-content>
          </mat-card>
          }

          @if (isNotice() && appeals().length > 0) {
          <mat-card class="tile-card">
            <mat-card-title>Submitted appeals</mat-card-title>
            <mat-card-content class="appeals-stack">
              @for (appeal of appeals(); track appeal.id) {
              <section class="appeal-block">
                <header>
                  <div class="appeal-meta">
                    <span class="label">Appeal</span>
                    <span>Filed {{ appeal.filedAt | date:'medium' }}</span>
                  </div>
                  <div class="status-chip" [ngClass]="{ 'resolved': !!appeal.resolvedAt, 'open': !appeal.resolvedAt }">
                    {{ formatAppealOutcome(appeal.outcome) }}
                  </div>
                </header>

                <div class="appeal-content">
                  <h4>Arguments</h4>
                  <p>{{ appeal.arguments }}</p>
                </div>

                @if (appeal.resolvedAt) {
                <footer>
                  <div class="decision-meta">
                    <span class="label">Decision</span>
                    <span>Resolved {{ appeal.resolvedAt | date:'medium' }}</span>
                    @if (appeal.reviewer) {
                    <span>Reviewer: {{ appeal.reviewer }}</span>
                    }
                  </div>
                </footer>
                }
              </section>
              }
            </mat-card-content>
          </mat-card>
          }
        </div>
      </div>
      }
    </mat-tab>

    @if (canSubmitAppeal()) {
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="material-symbols-outlined">rate_review</mat-icon>
        <span>Submit appeal</span>
      </ng-template>

      <div class="tab-body">
        <p class="appeal-hint">
          You can provide additional context and optional contact details. Supporting documents help us review faster.
        </p>

        <form id="appeal-form" [formGroup]="appealForm" (ngSubmit)="submitAppeal()" class="appeal-form">
          <mat-form-field appearance="outline">
            <mat-label>Your explanation</mat-label>
            <textarea matInput rows="4" formControlName="arguments" required></textarea>
            <mat-hint align="end">Minimum 20 characters</mat-hint>
            @if (appealForm.controls.arguments.invalid && appealForm.controls.arguments.touched) {
            <mat-error>
              Please describe why you believe this decision should be reviewed.
            </mat-error>
            }
          </mat-form-field>

          <div class="url-upload">
            <app-evidence-input [showUrl]="true" [showFiles]="true"
              [disabled]="submitting() || uploading()"
              [urlItems]="appealUrlViews()"
              [fileItems]="attachmentViews()"
              [fileHint]="'PDF or image files, up to 5\u00A0MB each (10\u00A0MB total). Currently selected files: ' + attachmentsSizeLabel() + '.'"
              (urlAdd)="onAppealUrlAdd($event)"
              (filesSelect)="onAttachmentsPicked($event)"
              (urlRemove)="onAppealUrlRemove($event)"
              (fileRemove)="onAttachmentRemove($event)"></app-evidence-input>
          </div>
        </form>
      </div>
    </mat-tab>
    }
  </mat-tab-group>
  }
  } @else {
  <div class="loading">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    <p>Loading status…</p>
  </div>
  }
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-flat-button color="primary" (click)="close()">Close</button>
  @if (!loading() && !error() && activeTab() === 0) {
  <button mat-stroked-button color="primary" (click)="openPublicStatus()" [disabled]="!publicStatusUrl()">
    <mat-icon class="material-symbols-outlined">open_in_new</mat-icon>
    Open public page
  </button>
  }
  @if (!loading() && !error() && canSubmitAppeal() && activeTab() === 1) {
  <button mat-flat-button color="primary" type="submit" form="appeal-form" [disabled]="submitting() || uploading()">
    <mat-icon class="material-symbols-outlined">send</mat-icon>
    Submit appeal
  </button>
  }
</mat-dialog-actions>
