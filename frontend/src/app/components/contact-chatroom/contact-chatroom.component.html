<mat-card class="chatroom-card">
  <div class="chatroom-card__toolbar">
    <button class="button_back" mat-mini-fab color="accent" [attr.aria-label]="'common.contact.chatroom.closeAria' | transloco"
      (click)="closeChatroom()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    @if (messages().length !== 0) {
    <button class="button_add" mat-mini-fab color="primary"
      [attr.aria-label]="'common.contact.chatroom.composeAria' | transloco"
      (click)="requestCompose()">
      <mat-icon>add_comment</mat-icon>
    </button>
    }
  </div>

  @if (contact(); as activeContact) {
  <mat-card-content #messageScroll class="chatroom-card__content">
    <div class="message-content">
      @for (msg of messages(); track msg.id; let last = $last; let idx = $index) {
      @if (isNewDay(idx)) {
      <div class="day-separator">
        <span class="day-separator__line"></span>
        <span class="day-separator__label">{{ formatDay(msg.createdAt) }}</span>
        <span class="day-separator__line"></span>
      </div>
      }
      <div class="message" #messageRow [attr.data-message-id]="msg.messageId" [class.message--unread]="isUnread(msg)">
        @if (msg.direction === 'user') {
        <div class="bubble-row me">
          <div class="avatar-me">
            @if (profile.base64Avatar) {
            <img class="avatar" [src]="profile.base64Avatar"
              [attr.alt]="profile.name ? ('common.contact.chatroom.avatarAltName' | transloco:{ name: profile.name }) : ('common.contact.chatroom.avatarAltMe' | transloco)" />
            } @else {
            <mat-icon>person</mat-icon>
            }
            <span class="name">{{ profile.name || ('common.contact.chatroom.meLabel' | transloco) }}</span>
          </div>
          <div class="status-chip status-chip--me">
            <mat-icon>{{ mapStatus(msg.status) }}</mat-icon>
          </div>
          <div class="bubble bubble--me">
            @if (!msg.payload) {
            <div class="message-warning">
              <mat-icon class="message-warning__icon">warning</mat-icon>
              <span>{{ 'common.contact.chatroom.messageUnreadable' | transloco }}</span>
            </div>
            } @else {
            @if (msg.payload?.multimedia?.type !== 'undefined') {
            <app-showmultimedia [multimedia]="msg.payload?.multimedia"></app-showmultimedia>
            }
            @if (msg.payload?.message?.trim() !== '') {
            <app-showmessage [message]="msg.payload!.message" [style]="msg.payload!.style"></app-showmessage>
            }
            }
            <div class="reaction-chip reaction-chip--me">
              <span>{{ msg.reaction || 'ðŸ«¥' }}</span>
            </div>
          </div>
          <div class="message-actions-row button-me">
            <div class="message-actions">
              @if (msg.payload) {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.contact.chatroom.editAria' | transloco"
                (click)="editMessage(msg)">
                <mat-icon>edit</mat-icon>
              </button>
              }
              <button mat-mini-fab color="warn" [attr.aria-label]="'common.contact.chatroom.deleteAria' | transloco"
                (click)="deleteMessage(msg)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
        } @else {
        <div class="bubble-row them">
          <div class="avatar-them">
            @if (activeContact.base64Avatar) {
            <img class="avatar" [src]="activeContact.base64Avatar"
              [attr.alt]="activeContact.name ? ('common.contact.chatroom.avatarAltName' | transloco:{ name: activeContact.name }) : ('common.contact.chatroom.avatarAltContact' | transloco)" />
            } @else {
            <mat-icon>person</mat-icon>
            }
            <span class="name">{{ activeContact.name || ('common.contact.chatroom.contactLabel' | transloco) }}</span>
          </div>
          <div class="status-chip status-chip--them">
            <mat-icon>{{ mapStatus(msg.status) }}</mat-icon>
          </div>
          <div class="bubble bubble--them">
            @if (!msg.payload) {
            <div class="message-warning">
              <mat-icon class="message-warning__icon">warning</mat-icon>
              <span>{{ 'common.contact.chatroom.messageUnreadable' | transloco }}</span>
            </div>
            } @else {
            @if (msg.payload?.multimedia?.type !== 'undefined') {
            <app-showmultimedia [multimedia]="msg.payload?.multimedia"></app-showmultimedia>
            }
            @if (msg.payload?.message?.trim() !== '') {
            <app-showmessage [message]="getDisplayedMessage(msg)" [style]="msg.payload!.style"></app-showmessage>
            }
            }
            <div class="reaction-chip reaction-chip--them" role="button" tabindex="0"
              (click)="openReactionPicker(msg, $event)" (keyup.enter)="openReactionPicker(msg, $event)"
              (keyup.space)="openReactionPicker(msg, $event)">
              <span class="reaction-chip-menu">{{ msg.reaction || 'ðŸ«¥' }}</span>
            </div>
          </div>
          <div class="message-actions-row button-them">
            <div class="message-actions">
              @if (msg.payload?.message?.trim() !== '') {
              @if (msg.payload?.translatedMessage && !msg.showOriginal) {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.contact.chatroom.showOriginalAria' | transloco"
                (click)="showOriginalMessage(msg)">
                <mat-icon>undo</mat-icon>
              </button>
              } @else {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.contact.chatroom.translateAria' | transloco"
                (click)="translateMessage(msg)">
                <mat-icon>translate</mat-icon>
              </button>
              }
              }
              <button mat-mini-fab color="warn" [attr.aria-label]="'common.contact.chatroom.deleteAria' | transloco"
                (click)="deleteMessage(msg)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
        }
      </div>
      }

      @if (loaded() && messages().length === 0) {
      <button class="first-button" mat-flat-button color="primary" [attr.aria-hidden]="false"
        (click)="requestCompose()">
        <span>{{ 'common.contact.chatroom.firstMessage' | transloco }}</span>
      </button>
      }
    </div>
  </mat-card-content>
  } @else {
  <mat-card-content class="chatroom-card__content chatroom-card__content--empty">
    <span>{{ 'common.contact.chatroom.loading' | transloco }}</span>
  </mat-card-content>
  }
</mat-card>
