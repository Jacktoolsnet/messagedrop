@if (contact(); as activeContact) {
<h2 mat-dialog-title class="dialog-title chatroom-title">
  <button type="button" class="chatroom-title__profile" (click)="openContactSettings(activeContact)"
    (keyup.enter)="openContactSettings(activeContact)" (keyup.space)="openContactSettings(activeContact)"
    [attr.aria-label]="'common.contact.profile.title' | transloco">
    @if (activeContact.base64Avatar) {
    <img class="chatroom-title__avatar" [src]="activeContact.base64Avatar"
      [attr.alt]="activeContact.name ? ('common.contact.chatroom.avatarAltName' | transloco:{ name: activeContact.name }) : ('common.contact.chatroom.avatarAltContact' | transloco)" />
    } @else {
    <mat-icon class="dialog-title__icon">person</mat-icon>
    }
    <span class="dialog-title__text">{{ activeContact.name || ('common.contact.chatroom.contactLabel' | transloco) }}</span>
  </button>
</h2>

<mat-card class="chatroom-card">
  <mat-card-content #messageScroll class="chatroom-card__content"
    [style.--chatroom-bg-image]="getChatBackgroundImage(activeContact)"
    [style.--chatroom-bg-opacity]="getChatBackgroundOpacity(activeContact)">
    <div class="message-content">
      @for (msg of messages(); track msg.id; let last = $last; let idx = $index) {
      @if (isNewDay(idx)) {
      <div class="day-separator">
        <span class="day-separator__line"></span>
        <span class="day-separator__label">{{ formatDay(msg.createdAt) }}</span>
        <span class="day-separator__line"></span>
      </div>
      }
      <div class="message" #messageRow [attr.data-message-id]="msg.messageId" [class.message--unread]="isUnread(msg)">
        @if (msg.direction === 'user') {
        <div class="bubble-row me">
          <button type="button" class="avatar-me" (click)="openUserProfile()" (keyup.enter)="openUserProfile()"
            (keyup.space)="openUserProfile()" [attr.aria-label]="'common.user.profile.title' | transloco">
            @if (profile.base64Avatar) {
            <img class="avatar" [src]="profile.base64Avatar"
              [attr.alt]="profile.name ? ('common.contact.chatroom.avatarAltName' | transloco:{ name: profile.name }) : ('common.contact.chatroom.avatarAltMe' | transloco)" />
            } @else {
            <mat-icon>person</mat-icon>
            }
            <span class="name">{{ profile.name || ('common.contact.chatroom.meLabel' | transloco) }}</span>
          </button>
          <div class="status-chip status-chip--me">
            <mat-icon>{{ mapStatus(msg.status) }}</mat-icon>
          </div>
          <div class="bubble bubble--me">
            @if (!msg.payload) {
            <div class="message-warning">
              <mat-icon class="message-warning__icon">warning</mat-icon>
              <span>{{ 'common.contact.chatroom.messageUnreadable' | transloco }}</span>
            </div>
            } @else {
            @if (msg.payload.multimedia.type !== 'undefined') {
            <app-showmultimedia [multimedia]="msg.payload.multimedia"></app-showmultimedia>
            }
            @if (msg.payload.verified === false) {
            <div class="message-warning">
              <mat-icon class="message-warning__icon">gpp_bad</mat-icon>
              <span>{{ 'common.contact.chatroom.messageUnverified' | transloco }}</span>
            </div>
            }
            @if (msg.payload.message.trim() !== '') {
            <app-showmessage [message]="msg.payload!.message" [style]="msg.payload!.style"></app-showmessage>
            }
            }
            <div class="reaction-chip reaction-chip--me">
              <span>{{ msg.reaction || 'ðŸ«¥' }}</span>
            </div>
          </div>
          <div class="message-actions-row button-me">
            <div class="message-actions">
              @if (msg.payload) {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.contact.chatroom.editAria' | transloco"
                (click)="editMessage(msg)">
                <mat-icon>edit</mat-icon>
              </button>
              }
              <button mat-mini-fab color="warn" [attr.aria-label]="'common.contact.chatroom.deleteAria' | transloco"
                (click)="deleteMessage(msg)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
        } @else {
        <div class="bubble-row them">
          <button type="button" class="avatar-them" (click)="openContactSettings(activeContact)"
            (keyup.enter)="openContactSettings(activeContact)" (keyup.space)="openContactSettings(activeContact)"
            [attr.aria-label]="'common.contact.profile.title' | transloco">
            @if (activeContact.base64Avatar) {
            <img class="avatar" [src]="activeContact.base64Avatar"
              [attr.alt]="activeContact.name ? ('common.contact.chatroom.avatarAltName' | transloco:{ name: activeContact.name }) : ('common.contact.chatroom.avatarAltContact' | transloco)" />
            } @else {
            <mat-icon>person</mat-icon>
            }
            <span class="name">{{ activeContact.name || ('common.contact.chatroom.contactLabel' | transloco) }}</span>
          </button>
          <div class="status-chip status-chip--them">
            <mat-icon>{{ mapStatus(msg.status) }}</mat-icon>
          </div>
          <div class="bubble bubble--them">
            @if (!msg.payload) {
            <div class="message-warning">
              <mat-icon class="message-warning__icon">warning</mat-icon>
              <span>{{ 'common.contact.chatroom.messageUnreadable' | transloco }}</span>
            </div>
            } @else {
            @if (msg.payload.multimedia.type !== 'undefined') {
            <app-showmultimedia [multimedia]="msg.payload.multimedia"></app-showmultimedia>
            }
            @if (msg.payload.verified === false) {
            <div class="message-warning">
              <mat-icon class="message-warning__icon">gpp_bad</mat-icon>
              <span>{{ 'common.contact.chatroom.messageUnverified' | transloco }}</span>
            </div>
            }
            @if (msg.payload.message.trim() !== '') {
            <app-showmessage [message]="getDisplayedMessage(msg)" [style]="msg.payload!.style"></app-showmessage>
            }
            }
            <div class="reaction-chip reaction-chip--them" role="button" tabindex="0"
              (click)="openReactionPicker(msg, $event)" (keyup.enter)="openReactionPicker(msg, $event)"
              (keyup.space)="openReactionPicker(msg, $event)">
              <span class="reaction-chip-menu">{{ msg.reaction || 'ðŸ«¥' }}</span>
            </div>
          </div>
          <div class="message-actions-row button-them">
            <div class="message-actions">
              @if (msg.payload?.message?.trim() !== '') {
              @if (msg.payload?.translatedMessage && !msg.showOriginal) {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.contact.chatroom.showOriginalAria' | transloco"
                (click)="showOriginalMessage(msg)">
                <mat-icon>undo</mat-icon>
              </button>
              } @else {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.contact.chatroom.translateAria' | transloco"
                (click)="translateMessage(msg)">
                <mat-icon>translate</mat-icon>
              </button>
              }
              }
              <button mat-mini-fab color="warn" [attr.aria-label]="'common.contact.chatroom.deleteAria' | transloco"
                (click)="deleteMessage(msg)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
        }
      </div>
      }

    </div>
  </mat-card-content>
</mat-card>
} @else {
<h2 mat-dialog-title class="dialog-title chatroom-title">
  <mat-icon class="dialog-title__icon">person</mat-icon>
  <span class="dialog-title__text">{{ 'common.contact.chatroom.loading' | transloco }}</span>
</h2>
<mat-card class="chatroom-card">
  <mat-card-content class="chatroom-card__content chatroom-card__content--empty">
    <span>{{ 'common.contact.chatroom.loading' | transloco }}</span>
  </mat-card-content>
</mat-card>
}

<mat-dialog-actions class="sticky-actions" align="end">
  <button mat-icon-button class="action-close" [attr.aria-label]="'common.contact.chatroom.closeAria' | transloco"
    (click)="closeChatroom()">
    <mat-icon>close</mat-icon>
  </button>
  <button mat-icon-button color="primary" [attr.aria-label]="'common.contact.chatroom.composeAria' | transloco"
    (click)="requestCompose()">
    <mat-icon>add_comment</mat-icon>
  </button>
</mat-dialog-actions>
