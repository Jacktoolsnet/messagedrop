@if (contact(); as activeContact) {
<h2 mat-dialog-title class="dialog-title chatroom-title">
  <button type="button" class="chatroom-title__profile" (click)="openContactSettings(activeContact)"
    (keyup.enter)="openContactSettings(activeContact)" (keyup.space)="openContactSettings(activeContact)"
    [attr.aria-label]="'common.contact.profile.title' | transloco">
    @if (activeContact.base64Avatar) {
    <img class="chatroom-title__avatar" [src]="activeContact.base64Avatar"
      [attr.alt]="activeContact.name ? ('common.contact.chatroom.avatarAltName' | transloco:{ name: activeContact.name }) : ('common.contact.chatroom.avatarAltContact' | transloco)" />
    } @else {
    <mat-icon class="dialog-title__icon">person</mat-icon>
    }
    <span class="dialog-title__text">{{ activeContact.name || ('common.contact.chatroom.contactLabel' | transloco) }}</span>
  </button>
</h2>

<mat-card class="chatroom-card"
  [style.--chatroom-bg-image]="getChatBackgroundImage(activeContact)"
  [style.--chatroom-bg-opacity]="getChatBackgroundOpacity(activeContact)">
  @if (activeContact.avatarAttribution?.source === 'unsplash' && activeContact.chatBackgroundAttribution?.source === 'unsplash') {
  <div class="unsplash-badge unsplash-badge--chatroom">
    <span class="unsplash-badge__text">{{ 'common.avatarAttribution.photosBy' | transloco }}</span>
    <a class="unsplash-badge__link" [href]="activeContact.avatarAttribution?.authorUrl" target="_blank"
      rel="noopener">
      {{ activeContact.avatarAttribution?.authorName }}
    </a>
    <span class="unsplash-badge__text">{{ 'common.avatarAttribution.and' | transloco }}</span>
    <a class="unsplash-badge__link" [href]="activeContact.chatBackgroundAttribution?.authorUrl" target="_blank"
      rel="noopener">
      {{ activeContact.chatBackgroundAttribution?.authorName }}
    </a>
    <span class="unsplash-badge__text">{{ 'common.avatarAttribution.onUnsplash' | transloco }}</span>
    <a class="unsplash-badge__link"
      [href]="activeContact.avatarAttribution?.unsplashUrl || activeContact.chatBackgroundAttribution?.unsplashUrl"
      target="_blank" rel="noopener">
      Unsplash
    </a>
  </div>
  } @else if (activeContact.chatBackgroundAttribution ?? activeContact.avatarAttribution; as attribution) {
  @if (attribution.source === 'unsplash') {
  <div class="unsplash-badge unsplash-badge--chatroom">
    <span class="unsplash-badge__text">{{ 'common.avatarAttribution.photoBy' | transloco }}</span>
    <a class="unsplash-badge__link" [href]="attribution.authorUrl" target="_blank" rel="noopener">
      {{ attribution.authorName }}
    </a>
    <span class="unsplash-badge__text">{{ 'common.avatarAttribution.onUnsplash' | transloco }}</span>
    <a class="unsplash-badge__link" [href]="attribution.unsplashUrl" target="_blank" rel="noopener">
      Unsplash
    </a>
  </div>
  }
  }
  <mat-card-content #messageScroll class="chatroom-card__content">
    <div class="message-content">
      @if (audioLimitReached()) {
      <div class="system-notice">
        <div class="system-notice__chip">
          <mat-icon class="system-notice__icon">mic_off</mat-icon>
          <span>{{ 'common.contact.chatroom.audioLimitReached' | transloco }}</span>
        </div>
      </div>
      }
      @for (msg of messages(); track msg.id; let last = $last; let idx = $index) {
      @if (isNewDay(idx)) {
      <div class="day-separator">
        <span class="day-separator__line"></span>
        <span class="day-separator__label">{{ formatDay(msg.createdAt) }}</span>
        <span class="day-separator__line"></span>
      </div>
      }
      <div class="message" #messageRow [attr.data-message-id]="msg.messageId" [class.message--unread]="isUnread(msg)">
        @if (msg.direction === 'user') {
        <div class="bubble-row me">
          <button type="button" class="avatar-me" (click)="openUserProfile()" (keyup.enter)="openUserProfile()"
            (keyup.space)="openUserProfile()" [attr.aria-label]="'common.user.profile.title' | transloco">
            @if (profile().base64Avatar) {
            <img class="avatar" [src]="profile().base64Avatar"
              [attr.alt]="profile().name ? ('common.contact.chatroom.avatarAltName' | transloco:{ name: profile().name }) : ('common.contact.chatroom.avatarAltMe' | transloco)" />
            } @else {
            <mat-icon>person</mat-icon>
            }
            <span class="name">{{ profile().name || ('common.contact.chatroom.meLabel' | transloco) }}</span>
          </button>
          <div class="status-chip status-chip--me">
            <mat-icon>{{ mapStatus(msg.status) }}</mat-icon>
          </div>
          <div class="bubble bubble--me">
            @if (!msg.payload) {
            <div class="message-warning">
              <mat-icon class="message-warning__icon">warning</mat-icon>
              <span>{{ 'common.contact.chatroom.messageUnreadable' | transloco }}</span>
            </div>
            } @else {
            @if (msg.payload.multimedia.type !== 'undefined') {
            <app-showmultimedia [multimedia]="msg.payload.multimedia"></app-showmultimedia>
            }
            @if (msg.payload.verified === false) {
            <div class="message-warning">
              <mat-icon class="message-warning__icon">gpp_bad</mat-icon>
              <span>{{ 'common.contact.chatroom.messageUnverified' | transloco }}</span>
            </div>
            }
            @if (msg.payload.message.trim() !== '') {
            <app-showmessage [message]="msg.payload!.message" [style]="msg.payload!.style"></app-showmessage>
            }
            @if (msg.payload.experience) {
            <div class="chat-experience" role="button" tabindex="0"
              (click)="openExperienceDetails(msg.payload.experience)"
              (keyup.enter)="openExperienceDetails(msg.payload.experience)"
              (keyup.space)="openExperienceDetails(msg.payload.experience)">
              @if (getExperienceImage(msg.payload.experience); as imageUrl) {
              <img class="chat-experience__image" [src]="imageUrl" [alt]="getExperienceTitle(msg.payload.experience)" />
              } @else {
              <div class="chat-experience__image chat-experience__image--fallback">
                <mat-icon>local_activity</mat-icon>
              </div>
              }
              <div class="chat-experience__body">
                <span class="chat-experience__title">{{ getExperienceTitle(msg.payload.experience) }}</span>
                @if (getExperienceDuration(msg.payload.experience)) {
                <span class="chat-experience__meta">{{ getExperienceDuration(msg.payload.experience) }}</span>
                }
                @if (getExperiencePriceLabel(msg.payload.experience)) {
                <span class="chat-experience__price">{{ getExperiencePriceLabel(msg.payload.experience) }}</span>
                }
              </div>
            </div>
            }
            @if (msg.payload.audio) {
            <div class="chat-audio">
              @if (getAudioBars(msg); as audioBars) {
              @if (audioBars.length) {
              <div class="chat-audio__bars">
                @for (bar of audioBars; track $index) {
                <span class="chat-audio__bar"
                  [style.transform]="'scaleY(' + bar.value + ')'"
                  [class.chat-audio__bar--active]="bar.active"></span>
                }
              </div>
              } @else {
              <div class="chat-audio__wave"></div>
              }
              }
              <span class="chat-audio__duration">{{ getAudioTimer(msg) }}</span>
            </div>
            }
            @if (msg.payload.location) {
            <div class="chat-location">
              <app-location-preview [location]="msg.payload.location"></app-location-preview>
            </div>
            }
            }
            @if (msg.reaction) {
            <div class="reaction-chip reaction-chip--me">
              <span>{{ msg.reaction }}</span>
            </div>
            }
          </div>
          <div class="message-actions-row button-me">
            <div class="message-actions">
              @if (msg.payload?.audio) {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.audioRecorder.play' | transloco"
                (click)="toggleAudioPlayback(msg)">
                <mat-icon>{{ isAudioPlaying(msg) ? 'pause' : 'play_arrow' }}</mat-icon>
              </button>
              }
              @if (msg.payload?.experience; as exp) {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.experiences.showMore' | transloco"
                (click)="openExperienceDetails(exp)">
                <mat-icon>expand_content</mat-icon>
              </button>
              }
              @if (msg.payload?.location; as loc) {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.contact.chatroom.showOnMap' | transloco"
                (click)="jumpToLocation(loc)">
                <mat-icon>my_location</mat-icon>
              </button>
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.contact.chatroom.openInMaps' | transloco"
                (click)="openLocationInMaps(loc)">
                <mat-icon>map</mat-icon>
              </button>
              }
              @if (msg.payload) {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.contact.chatroom.editAria' | transloco"
                (click)="editMessage(msg)">
                <mat-icon>edit</mat-icon>
              </button>
              }
              <button mat-mini-fab color="warn" [attr.aria-label]="'common.contact.chatroom.deleteAria' | transloco"
                (click)="deleteMessage(msg)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
        } @else {
        <div class="bubble-row them">
          <button type="button" class="avatar-them" (click)="openContactSettings(activeContact)"
            (keyup.enter)="openContactSettings(activeContact)" (keyup.space)="openContactSettings(activeContact)"
            [attr.aria-label]="'common.contact.profile.title' | transloco">
            @if (activeContact.base64Avatar) {
            <img class="avatar" [src]="activeContact.base64Avatar"
              [attr.alt]="activeContact.name ? ('common.contact.chatroom.avatarAltName' | transloco:{ name: activeContact.name }) : ('common.contact.chatroom.avatarAltContact' | transloco)" />
            } @else {
            <mat-icon>person</mat-icon>
            }
            <span class="name">{{ activeContact.name || ('common.contact.chatroom.contactLabel' | transloco) }}</span>
          </button>
          <div class="status-chip status-chip--them">
            <mat-icon>{{ mapStatus(msg.status) }}</mat-icon>
          </div>
          <div class="bubble bubble--them">
            @if (!msg.payload) {
            <div class="message-warning">
              <mat-icon class="message-warning__icon">warning</mat-icon>
              <span>{{ 'common.contact.chatroom.messageUnreadable' | transloco }}</span>
            </div>
            } @else {
            @if (msg.payload.multimedia.type !== 'undefined') {
            <app-showmultimedia [multimedia]="msg.payload.multimedia"></app-showmultimedia>
            }
            @if (msg.payload.verified === false) {
            <div class="message-warning">
              <mat-icon class="message-warning__icon">gpp_bad</mat-icon>
              <span>{{ 'common.contact.chatroom.messageUnverified' | transloco }}</span>
            </div>
            }
            @if (msg.payload.message.trim() !== '') {
            <app-showmessage [message]="getDisplayedMessage(msg)" [style]="msg.payload!.style"></app-showmessage>
            }
            @if (msg.payload.experience) {
            <div class="chat-experience" role="button" tabindex="0"
              (click)="openExperienceDetails(msg.payload.experience)"
              (keyup.enter)="openExperienceDetails(msg.payload.experience)"
              (keyup.space)="openExperienceDetails(msg.payload.experience)">
              @if (getExperienceImage(msg.payload.experience); as imageUrl) {
              <img class="chat-experience__image" [src]="imageUrl" [alt]="getExperienceTitle(msg.payload.experience)" />
              } @else {
              <div class="chat-experience__image chat-experience__image--fallback">
                <mat-icon>local_activity</mat-icon>
              </div>
              }
              <div class="chat-experience__body">
                <span class="chat-experience__title">{{ getExperienceTitle(msg.payload.experience) }}</span>
                @if (getExperienceDuration(msg.payload.experience)) {
                <span class="chat-experience__meta">{{ getExperienceDuration(msg.payload.experience) }}</span>
                }
                @if (getExperiencePriceLabel(msg.payload.experience)) {
                <span class="chat-experience__price">{{ getExperiencePriceLabel(msg.payload.experience) }}</span>
                }
              </div>
            </div>
            }
            @if (msg.payload.audio) {
            <div class="chat-audio">
              @if (getAudioBars(msg); as audioBars) {
              @if (audioBars.length) {
              <div class="chat-audio__bars">
                @for (bar of audioBars; track $index) {
                <span class="chat-audio__bar"
                  [style.transform]="'scaleY(' + bar.value + ')'"
                  [class.chat-audio__bar--active]="bar.active"></span>
                }
              </div>
              } @else {
              <div class="chat-audio__wave"></div>
              }
              }
              <span class="chat-audio__duration">{{ getAudioTimer(msg) }}</span>
            </div>
            }
            @if (msg.payload.location) {
            <div class="chat-location">
              <app-location-preview [location]="msg.payload.location"></app-location-preview>
            </div>
            }
            }
            <div class="reaction-chip reaction-chip--them" role="button" tabindex="0"
              (click)="openReactionPicker(msg, $event)" (keyup.enter)="openReactionPicker(msg, $event)"
              (keyup.space)="openReactionPicker(msg, $event)">
              <span class="reaction-chip-menu">{{ msg.reaction || 'ðŸ«¥' }}</span>
            </div>
          </div>
          <div class="message-actions-row button-them">
            <div class="message-actions">
              @if (msg.payload?.audio) {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.audioRecorder.play' | transloco"
                (click)="toggleAudioPlayback(msg)">
                <mat-icon>{{ isAudioPlaying(msg) ? 'pause' : 'play_arrow' }}</mat-icon>
              </button>
              }
              @if (msg.payload?.experience; as exp) {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.experiences.showMore' | transloco"
                (click)="openExperienceDetails(exp)">
                <mat-icon>expand_content</mat-icon>
              </button>
              }
              @if (msg.payload?.location; as loc) {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.contact.chatroom.showOnMap' | transloco"
                (click)="jumpToLocation(loc)">
                <mat-icon>my_location</mat-icon>
              </button>
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.contact.chatroom.openInMaps' | transloco"
                (click)="openLocationInMaps(loc)">
                <mat-icon>map</mat-icon>
              </button>
              }
              @if (msg.payload?.message?.trim() !== '') {
              @if (msg.payload?.translatedMessage && !msg.showOriginal) {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.contact.chatroom.showOriginalAria' | transloco"
                (click)="showOriginalMessage(msg)">
                <mat-icon>undo</mat-icon>
              </button>
              } @else {
              <button mat-mini-fab color="primary" [attr.aria-label]="'common.contact.chatroom.translateAria' | transloco:{ language: translationTargetLabel() }"
                (click)="translateMessage(msg)">
                <mat-icon>translate</mat-icon>
              </button>
              }
              }
              <button mat-mini-fab color="warn" [attr.aria-label]="'common.contact.chatroom.deleteAria' | transloco"
                (click)="deleteMessage(msg)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
        }
      </div>
      }

    </div>
  </mat-card-content>
</mat-card>
} @else {
<h2 mat-dialog-title class="dialog-title chatroom-title">
  <mat-icon class="dialog-title__icon">person</mat-icon>
  <span class="dialog-title__text">{{ 'common.contact.chatroom.loading' | transloco }}</span>
</h2>
<mat-card class="chatroom-card">
  <mat-card-content class="chatroom-card__content chatroom-card__content--empty">
    <span>{{ 'common.contact.chatroom.loading' | transloco }}</span>
  </mat-card-content>
</mat-card>
}

<mat-dialog-actions class="sticky-actions" align="end">
  <button mat-icon-button class="action-close" [attr.aria-label]="'common.contact.chatroom.closeAria' | transloco"
    (click)="closeChatroom()">
    <mat-icon>close</mat-icon>
  </button>
  <button mat-icon-button type="button" (click)="help.open('myContactChatroom')"
    [attr.aria-label]="'common.actions.help' | transloco">
    <mat-icon>help</mat-icon>
  </button>
  <button mat-icon-button type="button" [attr.aria-label]="'common.contact.chatroom.addExperienceAria' | transloco"
    (click)="openExperienceSearch()">
    <mat-icon>bookmark_add</mat-icon>
  </button>
  <button mat-icon-button type="button" [attr.aria-label]="'common.contact.chatroom.addLocationAria' | transloco"
    (click)="openLocationPicker()">
    <mat-icon>add_location_alt</mat-icon>
  </button>
  <button mat-icon-button type="button" [attr.aria-label]="'common.contact.chatroom.addVoiceAria' | transloco"
    (click)="openAudioRecorder()" [disabled]="audioLimitReached()">
    <mat-icon>mic</mat-icon>
  </button>
  <button mat-icon-button color="primary" [attr.aria-label]="'common.contact.chatroom.composeAria' | transloco"
    (click)="requestCompose()">
    <mat-icon>add_comment</mat-icon>
  </button>
</mat-dialog-actions>
