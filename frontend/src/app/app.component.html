@if (appService.isSettingsReady() && !appService.isConsentCompleted()) {
<app-consent-gate></app-consent-gate>
} @else {
<app-map [lastMarkerUpdate]="lastMarkerUpdate" [location]="mapService.getMapLocation()"
    [markerLocations]="markerLocations" (clickEvent)="handleClickEvent($event)" (moveEndEvent)="handleMoveEndEvent()"
    (markerClickEvent)="handleMarkerClickEvent($event)">
</app-map>

@if (!networkService.backendOnline() || maintenanceActive()) {
<button mat-fab class="button_backend_status" (click)="showBackendOfflineInfo()"
    [attr.aria-label]="maintenanceActive() ? ('common.maintenance.title' | transloco) : ('common.serverDown.title' | transloco)">
    <mat-icon aria-hidden="false">{{ maintenanceActive() ? 'construction' : 'cloud_off' }}</mat-icon>
</button>
}

@if (userService.isBlocked()) {
<button aria-hidden="false" class="button_profile" mat-fab color="accent"
    [attr.aria-label]="'common.aria.wait' | transloco">
    <mat-icon aria-hidden="false">hourglass_top</mat-icon>
</button>
} @else if (!userService.isReady()) {
<button aria-hidden="false" class="button_profile" mat-fab color="accent"
    [attr.aria-label]="'common.aria.userProfile' | transloco"
    (click)="userService.login(loadLocalDataAfterLogin.bind(this))">
    <mat-icon aria-hidden="false">lock_open</mat-icon>
</button>
} @else {
<button [matMenuTriggerFor]="userMenu" aria-hidden="false" class="button_profile" mat-fab
    [attr.aria-label]="'common.aria.userProfile' | transloco" (click)="{}">
    <mat-icon [attr.aria-hidden]="false"
        [matBadge]="userService.isReady() ? (unreadTotalAll() > 0 ? (unreadTotalAll() | shortNumber) : null) : null"
        [matBadgeHidden]="!userService.isReady()" [matBadgeSize]="'medium'" matBadgeColor="primary">person</mat-icon>
</button>
}

<button [attr.aria-hidden]="false" [matMenuTriggerFor]="appMenu" class="button_app" mat-fab
    [attr.aria-label]="'common.aria.appMenu' | transloco" (click)="{}">
    <mat-icon [attr.aria-hidden]="false">apps</mat-icon>
</button>

<button [attr.aria-hidden]="false" [matMenuTriggerFor]="messageMenu" class="button_drop" mat-fab
    [attr.aria-label]="'common.aria.mainMenu' | transloco" (click)="{}">
    <mat-icon [attr.aria-hidden]="false">pin_drop</mat-icon>
</button>

<button [attr.aria-hidden]="false" [matMenuTriggerFor]="searchMenu" class="button_search" mat-fab
    [attr.aria-label]="'common.aria.search' | transloco" (click)="{}">
    <mat-icon [attr.aria-hidden]="false">search</mat-icon>
</button>

<mat-menu #userMenu="matMenu">
    @if (userService.isReady()) {
    <button mat-menu-item (click)="logout()">
        <mat-icon>lock</mat-icon>
        <span>{{ 'common.menu.logout' | transloco }}</span>
    </button>
    }

    @if (userService.isReady()) {
    @if (!userService.hasJwt() && networkService.backendOnline() && !maintenanceActive()) {
    <button mat-menu-item (click)="connectToBackend()" [disabled]="userService.isConnectingToBackend()">
        <mat-icon>cloud_sync</mat-icon>
        <span>{{ 'common.menu.connectBackend' | transloco }}</span>
    </button>
    }
    }

    @if (userService.isReady()) {
    <button mat-menu-item (click)="showUser()">
        <mat-icon>account_circle</mat-icon>
        <span>{{ 'common.menu.myUser' | transloco }}</span>
    </button>
    }

    @if (userService.isReady()) {
    <button mat-menu-item (click)="editUserProfile()">
        <mat-icon>badge</mat-icon>
        <span>{{ 'common.menu.myProfile' | transloco }}</span>
    </button>
    }

    @if (userService.hasJwt()) {
    <button mat-menu-item (click)="openSystemMessages()">
        <mat-icon [attr.aria-hidden]="false"
            [matBadge]="hasUnreadSystemNotifications() ? (unreadSystemNotificationCount() | shortNumber) : null"
            [matBadgeHidden]="!hasUnreadSystemNotifications()" matBadgeColor="primary">notifications</mat-icon>
        <span>{{ 'common.menu.systemMessages' | transloco }}</span>
    </button>
    }

    @if (userService.hasJwt()) {
    <button mat-menu-item (click)="openUserMessagListDialog()">
        <mat-icon>speaker_notes</mat-icon>
        <span>{{ 'common.menu.myPublicMessages' | transloco }}</span>
    </button>
    }

    @if (userService.isReady()) {
    <button mat-menu-item (click)="openNoteListDialog()">
        <mat-icon>clinical_notes</mat-icon>
        <span>{{ 'common.menu.myPrivateNotes' | transloco }}</span>
    </button>
    }

    @if (userService.isReady() && placeService.isReady()) {
    <button mat-menu-item (click)="openPlaceListDialog()">
        <mat-icon>personal_places</mat-icon>
        <span>{{ 'common.menu.myPlaces' | transloco }}</span>
    </button>
    }

    @if (userService.isReady()) {
    <button mat-menu-item (click)="openMyExperiencesListDialog()">
        <mat-icon>bookmark_star</mat-icon>
        <span>{{ 'common.menu.myExperiences' | transloco }}</span>
    </button>
    }

    @if (userService.isReady() && contactService.isReady()) {
    <button mat-menu-item (click)="openContactListDialog()">
        <mat-icon [attr.aria-hidden]="false" matBadge="{{ getContactsBadge() }}" [matBadgeHidden]="!getContactsBadge()"
            matBadgeColor="warn" matBadgeOverlap="true">contacts</mat-icon>
        <span>{{ 'common.menu.myContacts' | transloco }}</span>
    </button>
    }
</mat-menu>

@if (powService.solving()) {
<div class="pow-overlay" role="status" aria-live="polite">
    <div class="pow-dialog">
        <mat-progress-spinner diameter="32" mode="indeterminate"></mat-progress-spinner>
        <div class="pow-text">{{ 'common.powSolving' | transloco }}</div>
    </div>
</div>
}

<mat-menu #appMenu="matMenu">
    <button mat-menu-item (click)="editAppSettings()">
        <mat-icon>settings_applications</mat-icon>
        <span>{{ 'common.menu.appSettings' | transloco }}</span>
    </button>
    <button mat-menu-item (click)="openSearchSettings()">
        <mat-icon>manage_search</mat-icon>
        <span>{{ 'common.menu.searchSettings' | transloco }}</span>
    </button>
    <button mat-menu-item (click)="editExternalContentSettings()">
        <mat-icon>public</mat-icon>
        <span>{{ 'common.menu.externalContentSettings' | transloco }}</span>
    </button>
    <button mat-menu-item (click)="startRestore()">
        <mat-icon>restore</mat-icon>
        <span>{{ 'common.menu.restoreBackup' | transloco }}</span>
    </button>
    <button mat-menu-item (click)="showTermsOfService()">
        <mat-icon>rule</mat-icon>
        <span>{{ 'common.menu.termsOfService' | transloco }}</span>
    </button>
    <button mat-menu-item (click)="showPrivacyPolicy()">
        <mat-icon>privacy_tip</mat-icon>
        <span>{{ 'common.menu.privacyPolicy' | transloco }}</span>
    </button>
    <button mat-menu-item (click)="showDisclaimer()">
        <mat-icon>policy</mat-icon>
        <span>{{ 'common.menu.disclaimer' | transloco }}</span>
    </button>
    <button mat-menu-item (click)="showLegalNotice()">
        <mat-icon>gavel</mat-icon>
        <span>{{ 'common.menu.imprintLegalNotice' | transloco }}</span>
    </button>
    <button mat-menu-item (click)="showLicenses()">
        <mat-icon>receipt_long</mat-icon>
        <span>{{ 'common.menu.thirdPartyLicenses' | transloco }}</span>
    </button>
</mat-menu>

<mat-menu #messageMenu="matMenu">
    <button mat-menu-item (click)="getCurrentPosition()">
        <mat-icon [attr.aria-hidden]="locationReady">my_location</mat-icon>
        <span>{{ 'common.menu.locateMe' | transloco }}</span>
    </button>

    @if (!userService.isReady() || userService.hasJwt()) {
    <button mat-menu-item
        (click)="!userService.isReady() ? userService.loginWithBackend(openMessagDialog.bind(this)) : openMessagDialog()">
        @if (!userService.isReady()){
        <mat-icon>locked</mat-icon>
        } @else {
        <mat-icon>send</mat-icon>
        }
        <span>{{ 'common.menu.publicMessage' | transloco }}</span>
    </button>
    }
    <button mat-menu-item
        (click)="!userService.isReady() ? userService.login(openNoteDialog.bind(this)) : openNoteDialog()">
        @if (!userService.isReady()){
        <mat-icon>locked</mat-icon>
        } @else {
        <mat-icon>add_notes</mat-icon>
        }
        <span>{{ 'common.menu.privateNote' | transloco }}</span>
    </button>
    <button mat-menu-item
        (click)="!userService.isReady() ? userService.login(openAddImageDialog.bind(this)) : openAddImageDialog()">
        @if (!userService.isReady()){
        <mat-icon>locked</mat-icon>
        } @else {
        <mat-icon>image_search</mat-icon>
        }
        <span>{{ 'common.menu.privateImage' | transloco }}</span>
    </button>
    <button mat-menu-item
        (click)="!userService.isReady() ? userService.login(openAddDocumentDialog.bind(this)) : openAddDocumentDialog()">
        @if (!userService.isReady()){
        <mat-icon>locked</mat-icon>
        } @else {
        <mat-icon>description</mat-icon>
        }
        <span>{{ 'common.menu.privateDocument' | transloco }}</span>
    </button>
    @if (!userService.isReady() || userService.hasJwt()) {
    <!--button mat-menu-item
        (click)="!userService.isReady() ? userService.loginWithBackend(openContactListDialog.bind(this)) : openContactListDialog()">
        @if (!userService.isReady()){
        <mat-icon>locked</mat-icon>
        } @else {
        <mat-icon>contacts</mat-icon>
        }
        <span>{{ 'common.menu.contactsMessage' | transloco }}</span>
    </button-->
    }

    @if (networkService.backendOnline() && !maintenanceActive()) {
    <button mat-menu-item (click)="showWeather()">
        <mat-icon>weather_mix</mat-icon>
        <span>{{ 'common.menu.weather' | transloco }}</span>
    </button>

    <button mat-menu-item (click)="showAirQuality()">
        <mat-icon>eco</mat-icon>
        <span>{{ 'common.menu.airQuality' | transloco }}</span>
    </button>
    }

    <!--button mat-menu-item (click)="showGeoStatistic()">
        <mat-icon >data_exploration</mat-icon>
        <span>Statistic</span>
    </button-->
</mat-menu>

<mat-menu #searchMenu="matMenu">
    <button mat-menu-item (click)="showNominatimSearchDialog()">
        <mat-icon>travel_explore</mat-icon>
        <span>{{ 'common.menu.searchPlace' | transloco }}</span>
    </button>
    <button mat-menu-item (click)="showExperienceSearchDialog()">
        <mat-icon>local_activity</mat-icon>
        <span>{{ 'common.menu.searchExperiences' | transloco }}</span>
    </button>
</mat-menu>
}
<router-outlet />