@if (appService.isSettingsReady() && !appService.isConsentCompleted()) {
<app-consent-gate></app-consent-gate>
} @else {
@if (networkService.isOnline() && serverService.isReady()) {
<app-map [lastMarkerUpdate]="lastMarkerUpdate" [location]="mapService.getMapLocation()"
    [markerLocations]="markerLocations" (clickEvent)="handleClickEvent($event)" (moveEndEvent)="handleMoveEndEvent()"
    (markerClickEvent)="handleMarkerClickEvent($event)">
</app-map>

@if (userService.isBlocked()) {
<button aria-hidden="false" class="button_profile" mat-fab color="accent" aria-label="Wait">
    <mat-icon aria-hidden="false">hourglass_top</mat-icon>
</button>
} @else if (!userService.isReady()) {
<button aria-hidden="false" class="button_profile" mat-fab color="accent" aria-label="User Profile"
    (click)="userService.login(loadLocalDataAfterLogin.bind(this))">
    <mat-icon aria-hidden="false">lock_open</mat-icon>
</button>
} @else {
<button [matMenuTriggerFor]="userMenu" aria-hidden="false" class="button_profile" mat-fab aria-label="User Profile"
    (click)="{}" [@badgePulse]="animateUserBadgeTick()">
    <mat-icon [attr.aria-hidden]="false"
        [matBadge]="userService.isReady() ? (unreadTotalAll() > 0 ? (unreadTotalAll() | shortNumber) : null) : null"
        [matBadgeHidden]="!userService.isReady()" [matBadgeSize]="'medium'" matBadgeColor="primary">person</mat-icon>
</button>
}

<button [attr.aria-hidden]="false" [matMenuTriggerFor]="appMenu" class="button_app" mat-fab aria-label="Appmenu"
    (click)="{}">
    <mat-icon [attr.aria-hidden]="false">apps</mat-icon>
</button>

<button [attr.aria-hidden]="false" [matMenuTriggerFor]="messageMenu" class="button_drop" mat-fab aria-label="Mainmenu"
    (click)="{}">
    <mat-icon [attr.aria-hidden]="false">pin_drop</mat-icon>
</button>

<button [attr.aria-hidden]="false" [matMenuTriggerFor]="searchMenu" class="button_search" mat-fab aria-label="Search"
    (click)="{}">
    <mat-icon [attr.aria-hidden]="false">search</mat-icon>
</button>
}

<mat-menu #userMenu="matMenu">
    @if (userService.isReady()) {
    <button mat-menu-item (click)="logout()">
        <mat-icon>lock</mat-icon>
        <span>Logout</span>
    </button>
    }

    @if (userService.isReady()) {
    <button mat-menu-item (click)="showUser()">
        <mat-icon>account_circle</mat-icon>
        <span>My user</span>
    </button>
    }

    @if (userService.isReady()) {
    <button mat-menu-item (click)="editUserProfile()">
        <mat-icon>badge</mat-icon>
        <span>My profile</span>
    </button>
    }

    @if (userService.isReady()) {
    <button mat-menu-item (click)="openSystemMessages()">
        <mat-icon [attr.aria-hidden]="false"
            [matBadge]="hasUnreadSystemNotifications() ? (unreadSystemNotificationCount() | shortNumber) : null"
            [matBadgeHidden]="!hasUnreadSystemNotifications()" matBadgeColor="primary">notifications</mat-icon>
        <span>System messages</span>
    </button>
    }

    @if (userService.isReady()) {
    <button mat-menu-item (click)="openUserMessagListDialog()">
        <mat-icon>speaker_notes</mat-icon>
        <span>My public messages</span>
    </button>
    }

    @if (userService.isReady()) {
    <button mat-menu-item (click)="openNoteListDialog()">
        <mat-icon>clinical_notes</mat-icon>
        <span>My private notes</span>
    </button>
    }

    @if (userService.isReady() && placeService.isReady()) {
    <button mat-menu-item (click)="openPlaceListDialog()">
        <mat-icon>personal_places</mat-icon>
        <span>My places</span>
    </button>
    }

    @if (userService.isReady() && contactService.isReady()) {
    <button mat-menu-item (click)="openContactListDialog()">
        <mat-icon [attr.aria-hidden]="false" matBadge="{{ getContactsBadge() }}" [matBadgeHidden]="!getContactsBadge()"
            matBadgeColor="warn" matBadgeOverlap="true">contacts</mat-icon>
        <span>My contacts</span>
    </button>
    }
</mat-menu>

<mat-menu #appMenu="matMenu">
    <button mat-menu-item (click)="editAppSettings()">
        <mat-icon>settings_applications</mat-icon>
        <span>App settings</span>
    </button>
    <button mat-menu-item (click)="editExternalContentSettings()">
        <mat-icon>public</mat-icon>
        <span>External content settings</span>
    </button>
    <button mat-menu-item (click)="showTermsOfService()">
        <mat-icon>rule</mat-icon>
        <span>Terms of Service</span>
    </button>
    <button mat-menu-item (click)="showPrivacyPolicy()">
        <mat-icon>privacy_tip</mat-icon>
        <span>Privacy Policy</span>
    </button>
    <button mat-menu-item (click)="showDisclaimer()">
        <mat-icon>policy</mat-icon>
        <span>Disclaimer</span>
    </button>
    <button mat-menu-item (click)="showLegalNotice()">
        <mat-icon>gavel</mat-icon>
        <span>Imprint (Legal notice)</span>
    </button>
    <button mat-menu-item (click)="showLicenses()">
        <mat-icon>receipt_long</mat-icon>
        <span>Third-Party Licenses</span>
    </button>
</mat-menu>

<mat-menu #messageMenu="matMenu">
    <button mat-menu-item (click)="getCurrentPosition()">
        <mat-icon [attr.aria-hidden]="locationReady">place</mat-icon>
        <span>Locate me</span>
    </button>

    <button mat-menu-item
        (click)="!userService.isReady() ? userService.login(openMessagDialog.bind(this)) : openMessagDialog()">
        @if (!userService.isReady()){
        <mat-icon>locked</mat-icon>
        } @else {
        <mat-icon>send</mat-icon>
        }
        <span>Public message</span>
    </button>
    <button mat-menu-item
        (click)="!userService.isReady() ? userService.login(openNoteDialog.bind(this)) : openNoteDialog()">
        @if (!userService.isReady()){
        <mat-icon>locked</mat-icon>
        } @else {
        <mat-icon>add_notes</mat-icon>
        }
        <span>Private note</span>
    </button>
    <button mat-menu-item
        (click)="!userService.isReady() ? userService.login(openAddImageDialog.bind(this)) : openAddImageDialog()">
        @if (!userService.isReady()){
        <mat-icon>locked</mat-icon>
        } @else {
        <mat-icon>image_search</mat-icon>
        }
        <span>Private image</span>
    </button>
    <button mat-menu-item
        (click)="!userService.isReady() ? userService.login(openContactListDialog.bind(this)) : openContactListDialog()">
        @if (!userService.isReady()){
        <mat-icon>locked</mat-icon>
        } @else {
        <mat-icon>contacts</mat-icon>
        }
        <span>Contacts message</span>
    </button>

    <button mat-menu-item (click)="showWeather()">
        <mat-icon>weather_mix</mat-icon>
        <span>Weather</span>
    </button>

    <button mat-menu-item (click)="showAirQuality()">
        <mat-icon>eco</mat-icon>
        <span>Air quality</span>
    </button>

    <!--button mat-menu-item (click)="showGeoStatistic()">
        <mat-icon >data_exploration</mat-icon>
        <span>Statistic</span>
    </button-->
</mat-menu>

<mat-menu #searchMenu="matMenu">
    <button mat-menu-item (click)="showNominatimSearchDialog()">
        <mat-icon>travel_explore</mat-icon>
        <span>Search a place</span>
    </button>
</mat-menu>
}
<router-outlet />